(window.webpackJsonp=window.webpackJsonp||[]).push([[65],{Krps:function(t,n,e){"use strict";e.r(n);var s=e("8Y7J"),i=e("mrSG"),l=e("ZZ/e"),o=e("Z18M"),r=e("R3bG"),a=e("QQnz"),u=e("rk9M"),c=e("OUMn"),h=e("h5tO"),d=function(t){return t[t.idle=0]="idle",t[t.downloading=1]="downloading",t[t.waitingUnplug=2]="waitingUnplug",t[t.switching=3]="switching",t[t.finish=4]="finish",t}({});class b{constructor(t,n,e,s,l,o,u,c,b,m){this.navCtrl=t,this.translate=n,this.mobileBackend=e,this.solosConnector=s,this.events=l,this.zone=o,this.platform=u,this.insomnia=c,this.popupCtrl=b,this.activityStateManager=m,this.title="firmware.check-new-version",this.progressPercent=0,this.progress=0,this.stage=0,this.reconnectTimeout=null,this.isUpdating=!1,this.subscribeAction=null,this.abortedUpgrde=!1,this.enterBackgroundListeners=!1,this.downloadTimer=null,this.bClassicBTConnected=!1,this.bSPPBLEDisconnected=!1,this.currentStage=d.idle,this.unsubscribeEvents=()=>{this.events.unsubscribe(r.b,this.handleFWDownloadProgress),this.events.unsubscribe(r.h,this.handleSolosBTClassicConnected),this.events.unsubscribe(r.j,this.evtSolosConnected)},this.disableAndroidBackButton=()=>{null==this.subscribeAction&&(this.subscribeAction=this.platform.backButton.subscribeWithPriority(8964,()=>i.b(this,void 0,void 0,(function*(){}))))},this.enableAndroidBackButton=()=>{null!=this.subscribeAction&&(this.subscribeAction.unsubscribe(),this.subscribeAction=null)},this.registerEnterBackgroundListeners=()=>{this.enterBackgroundListeners||(this.enterBackgroundListeners=!0,document.addEventListener("pause",this.pause,!1),document.addEventListener("resume",this.resume,!1))},this.unregisterEnterBackgroundListeners=()=>{this.enterBackgroundListeners&&(this.enterBackgroundListeners=!1,document.removeEventListener("pause",this.pause,!1),document.removeEventListener("resume",this.resume,!1))},this.setReconnectTimeout=()=>{null==this.reconnectTimeout&&(this.reconnectTimeout=setTimeout(()=>{this.showAlertTimeoutError()},3e5))},this.clearReconnectTimeout=()=>{null!=this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=null)},this.setDownloadTimeout=()=>{null==this.downloadTimer&&(this.downloadTimer=setTimeout(()=>i.b(this,void 0,void 0,(function*(){yield this.solosConnector.abortFirmwareDownload(),this.showAbortDownloadError()})),6e4))},this.clearDownloadTimeout=()=>{null!=this.downloadTimer&&(clearTimeout(this.downloadTimer),this.downloadTimer=null)},this.handleFWDownloadProgress=t=>i.b(this,void 0,void 0,(function*(){console.log("handleFWDownloadProgress : stage - "+t.stage+", progress - "+t.progress);try{this.clearDownloadTimeout(),1==Number(t.stage)?(this.currentStage=d.waitingUnplug,this.zone.run(()=>{this.stage=2,this.title=this.translate.instant("firmware.restart-new-firmware")}),this.events.unsubscribe(r.b,this.handleFWDownloadProgress),this.unregisterEnterBackgroundListeners(),this.bClassicBTConnected=!1,this.bSPPBLEDisconnected=!1,this.events.subscribe(r.k,this.evtSolosDisconnected),this.events.subscribe(r.h,this.handleSolosBTClassicConnected),this.solosConnector.resumeAutoScan(),this.solosConnector.upgadeFirmware(),this.setReconnectTimeout()):(this.zone.run(()=>{this.progress=t.progress,this.progressPercent=Math.round(100*this.progress)}),this.setDownloadTimeout())}catch(n){alert(n.message)}})),this.handleSolosBTClassicConnected=()=>{this.events.unsubscribe(r.h,this.handleSolosBTClassicConnected),this.bClassicBTConnected=!0,this.proceedToAutoScan()},this.evtSolosConnected=t=>{this.clearReconnectTimeout(),this.events.unsubscribe(r.j,this.evtSolosConnected),this.isUpdating=!1,this.currentStage=d.finish,this.showAlertFirmwareUpdated()},this.evtSolosDisconnected=t=>{if(this.currentStage==d.waitingUnplug)this.currentStage=d.switching,this.bSPPBLEDisconnected=!0,this.proceedToAutoScan();else if(this.currentStage!=d.finish){const t=this.translate.instant("global.error"),n=this.translate.instant("firmware.download-disconnected");this.shownPrompt(t,n)}},this.proceedToAutoScan=()=>{this.bClassicBTConnected&&this.bSPPBLEDisconnected&&this.events.subscribe(r.j,this.evtSolosConnected)},this.showAlertFirmwareUpdated=()=>i.b(this,void 0,void 0,(function*(){yield this.popupCtrl.presentAlertController({header:this.translate.instant("firmware.firmware-update"),message:this.translate.instant("firmware.firmware-updated"),buttons:[{text:this.translate.instant("global.okay"),role:"cancel",handler:()=>{this.pop()}}]},!0)})),this.showAlertFirmwareUpdateToDate=()=>i.b(this,void 0,void 0,(function*(){const t=this.translate.instant("firmware.firmware-update"),n=this.translate.instant("firmware.firmware-up-to-date");yield this.shownPrompt(t,n)})),this.showAlertFirmwareDownloadError=t=>i.b(this,void 0,void 0,(function*(){const n=this.translate.instant("global.error");let e=this.translate.instant("firmware.error-download-firmware");null!=t&&(e=`${this.translate.instant("firmware.error-download-firmware")} (${t})`),yield this.shownPrompt(n,e)})),this.showAlertTimeoutError=()=>i.b(this,void 0,void 0,(function*(){this.unsubscribeEvents();const t=this.translate.instant("global.error"),n=this.translate.instant("firmware.install-firmware-timeout");yield this.shownPrompt(t,n)})),this.showAbortDownloadError=t=>i.b(this,void 0,void 0,(function*(){yield this.shownPrompt(this.translate.instant("firmware.firmware-update"),this.translate.instant("firmware.abort-upgrade-timeout"),()=>i.b(this,void 0,void 0,(function*(){yield this.solosConnector.setPowerState(!1),this.solosConnector.resumeAutoScan(),this.pop()})))})),this.shownPrompt=(t,n,e=null)=>i.b(this,void 0,void 0,(function*(){yield this.popupCtrl.presentAlertController({header:t,message:n,buttons:[{text:this.translate.instant("global.okay"),role:"cancel",handler:null==e?()=>{this.pop()}:e}]},!0)})),this.upgradeFirmware=()=>i.b(this,void 0,void 0,(function*(){try{let t=[];t.push(new w(a.a,yield this.solosConnector.getFirmwareVersionCSR())),t.push(new w(a.b,yield this.solosConnector.getFirmwareVersionDSPG())),t.push(new w(a.c,yield this.solosConnector.getFirmwareVersionTOUCH()));let n=[];for(let e of t){const t=yield this.mobileBackend.firmwareUpgradeAvailable(e.type,e.version);null!=t&&n.push(t)}if(0!=n.length)if(this.disableAndroidBackButton(),this.solosConnector.getBatteryLevel()<.5){const t=this.translate.instant("global.error"),n=this.translate.instant("firmware.battery-below-50");this.shownPrompt(t,n)}else{const t=[...h.c,h.a.BASIC_TRAINING,h.a.CORE_TRAINING,h.a.POSTURE_MONITORING],e=this.activityStateManager.validate(t,h.a.FIRMWARE_UPDATE,"/firmware-update");e.status?yield this.popupCtrl.presentAlertController({header:this.translate.instant("firmware.firmware-update"),message:this.translate.instant("firmware.new-firmware-available"),buttons:[{text:this.translate.instant("global.no"),role:"cancel",handler:()=>{this.pop()}},{text:this.translate.instant("global.yes"),handler:()=>i.b(this,void 0,void 0,(function*(){this.enableAndroidBackButton(),this.currentStage=d.downloading,this.title="firmware.download-new-firmware";let t=[];for(let e of n){const n=yield this.mobileBackend.firmwareDownload(e);null!=n&&t.push(new g(e.type,n))}if(0!=t.length)for(let n of t)n.type==a.a&&(this.solosConnector.stopDeviceMonitoring(),this.solosConnector.pauseAutoScan(),this.events.subscribe(r.b,this.handleFWDownloadProgress),this.abortedUpgrde=!1,this.isUpdating=!0,this.title=this.translate.instant("firmware.install-new-firmware"),this.solosConnector.downloadFirmware(n.buffer,n.type),this.stage=1,this.setDownloadTimeout(),this.registerEnterBackgroundListeners(),this.disableAndroidBackButton());else this.showAlertFirmwareDownloadError()}))}]},!0):yield this.popupCtrl.presentAlertController({header:e.header,message:e.message,buttons:e.buttons},!0)}else this.showAlertFirmwareUpdateToDate()}catch(t){console.log(t),this.showAlertFirmwareDownloadError(t)}})),this.checkChargeingState=()=>i.b(this,void 0,void 0,(function*(){if(0==this.solosConnector.getBatteryChargingState())this.bClassicBTConnected=!1,this.bSPPBLEDisconnected=!1,this.events.subscribe(r.h,this.handleSolosBTClassicConnected),this.solosConnector.upgadeFirmware(),this.setReconnectTimeout();else{let t=yield this.popupCtrl.presentAlertController({header:this.translate.instant("firmware.firmware-update"),message:this.translate.instant("firmware.unplug-charger"),buttons:[{text:this.translate.instant("global.no"),role:"cancel",handler:()=>{this.pop()}},{text:this.translate.instant("global.yes"),handler:()=>i.b(this,void 0,void 0,(function*(){t.dismiss(),this.checkChargeingState()}))}]},!0)}})),this.pause=()=>i.b(this,void 0,void 0,(function*(){try{this.currentStage==d.downloading&&(this.abortedUpgrde=!0,yield this.solosConnector.abortFirmwareDownload())}catch(t){console.log(t.message)}})),this.resume=()=>i.b(this,void 0,void 0,(function*(){this.zone.run(()=>i.b(this,void 0,void 0,(function*(){try{this.abortedUpgrde&&(yield this.showAbortDownloadError(),this.abortedUpgrde=!1)}catch(t){console.log(t.message)}})))})),this.alwaysScreenOn=()=>i.b(this,void 0,void 0,(function*(){try{yield this.insomnia.keepAwake()}catch(t){console.log(t)}})),this.allowsScreenOff=()=>i.b(this,void 0,void 0,(function*(){try{yield this.insomnia.allowSleepAgain()}catch(t){console.log(t)}}))}ngOnInit(){this.currentStage=d.idle}ionViewDidEnter(){this.alwaysScreenOn(),this.upgradeFirmware()}ionViewWillLeave(){this.solosConnector.startDeviceMonitoring(),this.mobileBackend.firmwareCancelDownload(),this.events.unsubscribe(r.k,this.evtSolosDisconnected),this.unsubscribeEvents(),this.unregisterEnterBackgroundListeners(),this.enableAndroidBackButton(),this.clearDownloadTimeout(),this.allowsScreenOff()}pop(){this.navCtrl.pop()}}class w{constructor(t,n){this.type=t,this.version=n}}class g{constructor(t,n){this.type=t,this.buffer=n}}class m{}var p=e("pMnS"),f=e("oBZk"),v=e("SVse"),C=e("TSSN"),B=s.Ab({encapsulation:0,styles:[[".title[_ngcontent-%COMP%]{color:var(--solos-color-a);font-size:16px;width:90%;text-align:center}.container[_ngcontent-%COMP%]{display:-webkit-box;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;flex-direction:column;-webkit-box-align:center;align-items:center;-webkit-box-pack:center;justify-content:center;height:80%;width:80%;margin:0 auto}.sub-container[_ngcontent-%COMP%]{-webkit-box-flex:1;flex-grow:1;display:-webkit-box;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;flex-direction:column;-webkit-box-align:center;align-items:center;-webkit-box-pack:center;justify-content:center;width:100%}.progress-cls[_ngcontent-%COMP%]{width:80%}.progress-text[_ngcontent-%COMP%]{color:var(--solos-color-a);font-size:30px;align-self:flex-start;margin-bottom:5px}"]],data:{}});function k(t){return s.Xb(0,[(t()(),s.Cb(0,0,null,null,2,"ion-back-button",[["class","settings-back-button"],["text",""]],null,[[null,"click"]],(function(t,n,e){var i=!0;return"click"===n&&(i=!1!==s.Ob(t,2).onClick(e)&&i),i}),f.J,f.b)),s.Bb(1,49152,null,0,l.i,[s.j,s.p,s.F],{text:[0,"text"]},null),s.Bb(2,16384,null,0,l.j,[[2,l.jb],l.Jb],null,null)],(function(t,n){t(n,1,0,"")}),null)}function T(t){return s.Xb(0,[(t()(),s.Cb(0,0,null,null,1,"ion-spinner",[["class","center"],["color","spinner"]],null,null,null,f.kb,f.C)),s.Bb(1,49152,null,0,l.tb,[s.j,s.p,s.F],{color:[0,"color"]},null)],(function(t,n){t(n,1,0,"spinner")}),null)}function y(t){return s.Xb(0,[(t()(),s.Cb(0,0,null,null,1,"div",[["class","progress-text"]],null,null,null,null,null)),(t()(),s.Vb(1,null,["","%"]))],null,(function(t,n){t(n,1,0,n.component.progressPercent)}))}function S(t){return s.Xb(0,[(t()(),s.Cb(0,0,null,null,1,"ion-progress-bar",[["color","solos-color-d"]],null,null,null,f.bb,f.t)),s.Bb(1,49152,null,0,l.ab,[s.j,s.p,s.F],{color:[0,"color"],value:[1,"value"]},null)],(function(t,n){t(n,1,0,"solos-color-d",n.component.progress)}),null)}function A(t){return s.Xb(0,[(t()(),s.Cb(0,0,null,null,11,"ion-header",[],null,null,null,f.Q,f.i)),s.Bb(1,49152,null,0,l.D,[s.j,s.p,s.F],null,null),(t()(),s.Cb(2,0,null,0,9,"ion-toolbar",[["class","settings-header-background"],["mode","ios"]],null,null,null,f.ob,f.G)),s.Bb(3,49152,null,0,l.Db,[s.j,s.p,s.F],{mode:[0,"mode"]},null),(t()(),s.Cb(4,0,null,0,3,"ion-buttons",[["slot","start"]],null,null,null,f.L,f.d)),s.Bb(5,49152,null,0,l.n,[s.j,s.p,s.F],null,null),(t()(),s.rb(16777216,null,0,1,null,k)),s.Bb(7,16384,null,0,v.l,[s.X,s.T],{ngIf:[0,"ngIf"]},null),(t()(),s.Cb(8,0,null,0,3,"ion-title",[["class","settings-header-title"]],null,null,null,f.mb,f.E)),s.Bb(9,49152,null,0,l.Bb,[s.j,s.p,s.F],null,null),(t()(),s.Vb(10,0,["",""])),s.Pb(131072,C.j,[C.k,s.j]),(t()(),s.Cb(12,0,null,null,16,"ion-content",[["class","settings-background ion-padding-top"]],null,null,null,f.O,f.g)),s.Bb(13,49152,null,0,l.w,[s.j,s.p,s.F],null,null),(t()(),s.Cb(14,0,null,0,14,"div",[["class","container"]],null,null,null,null,null)),(t()(),s.Cb(15,0,null,null,2,"div",[["class","sub-container"]],null,null,null,null,null)),(t()(),s.Cb(16,0,null,null,1,"ion-icon",[["color","solos-color-a"],["mode","ios"],["name","construct"],["style","font-size:100px"]],null,null,null,f.R,f.j)),s.Bb(17,49152,null,0,l.E,[s.j,s.p,s.F],{color:[0,"color"],mode:[1,"mode"],name:[2,"name"]},null),(t()(),s.Cb(18,0,null,null,3,"div",[["class","sub-container"]],null,null,null,null,null)),(t()(),s.Cb(19,0,null,null,2,"div",[["class","title"]],null,null,null,null,null)),(t()(),s.Vb(20,null,["",""])),s.Pb(131072,C.j,[C.k,s.j]),(t()(),s.Cb(22,0,null,null,6,"div",[["class","sub-container progress-cls"]],null,null,null,null,null)),(t()(),s.rb(16777216,null,null,1,null,T)),s.Bb(24,16384,null,0,v.l,[s.X,s.T],{ngIf:[0,"ngIf"]},null),(t()(),s.rb(16777216,null,null,1,null,y)),s.Bb(26,16384,null,0,v.l,[s.X,s.T],{ngIf:[0,"ngIf"]},null),(t()(),s.rb(16777216,null,null,1,null,S)),s.Bb(28,16384,null,0,v.l,[s.X,s.T],{ngIf:[0,"ngIf"]},null)],(function(t,n){var e=n.component;t(n,3,0,"ios"),t(n,7,0,!e.isUpdating),t(n,17,0,"solos-color-a","ios","construct"),t(n,24,0,1!=e.stage),t(n,26,0,1==e.stage),t(n,28,0,1==e.stage)}),(function(t,n){var e=n.component;t(n,10,0,s.Wb(n,10,0,s.Ob(n,11).transform("firmware.firmware-update"))),t(n,20,0,s.Wb(n,20,0,s.Ob(n,21).transform(e.title)))}))}function D(t){return s.Xb(0,[(t()(),s.Cb(0,0,null,null,1,"app-firmware-update",[],null,null,null,A,B)),s.Bb(1,114688,null,0,b,[l.Jb,C.k,o.c,r.l,l.f,s.F,l.Mb,u.a,c.a,h.b],null,null)],(function(t,n){t(n,1,0)}),null)}var F=s.yb("app-firmware-update",b,D,{},{},[]),P=e("s7LF"),x=e("iInd");e.d(n,"FirmwareUpdatePageModuleNgFactory",(function(){return E}));var E=s.zb(m,[],(function(t){return s.Lb([s.Mb(512,s.m,s.kb,[[8,[p.a,F]],[3,s.m],s.D]),s.Mb(4608,v.n,v.m,[s.z,[2,v.z]]),s.Mb(4608,P.j,P.j,[]),s.Mb(4608,l.c,l.c,[s.F,s.g]),s.Mb(4608,l.Ib,l.Ib,[l.c,s.m,s.w]),s.Mb(4608,l.Nb,l.Nb,[l.c,s.m,s.w]),s.Mb(1073742336,v.b,v.b,[]),s.Mb(1073742336,P.i,P.i,[]),s.Mb(1073742336,P.b,P.b,[]),s.Mb(1073742336,l.Fb,l.Fb,[]),s.Mb(1073742336,C.h,C.h,[]),s.Mb(1073742336,x.o,x.o,[[2,x.t],[2,x.m]]),s.Mb(1073742336,m,m,[]),s.Mb(1024,x.k,(function(){return[[{path:"",component:b}]]}),[])])}))}}]);
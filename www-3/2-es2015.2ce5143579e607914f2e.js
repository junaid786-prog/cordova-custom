(window.webpackJsonp=window.webpackJsonp||[]).push([[2],{"6gT1":function(t,i,e){"use strict";e.d(i,"b",(function(){return c})),e.d(i,"a",(function(){return o}));var s=e("mrSG"),a=(e("ZZ/e"),e("lIDq")),n=e("lvyt");e("Z18M"),e("OUMn");const h=16;var r=function(t){return t[t.CURRENT=0]="CURRENT",t[t.START=1]="START",t[t.STOP=2]="STOP",t}({});class c{constructor(t,i,e,a,n,c,o){this.route=t,this.router=i,this.coachSettings=e,this.backend=a,this.navCtrl=n,this.translate=c,this.popupCtrl=o,this.startDate="",this.startTime="",this.elapsedHH=0,this.elapsedmm=0,this.elapsedss=0,this.distance=0,this.avgPacingmm=-1,this.avgPacingss=-1,this.maxPacingmm=-1,this.maxPacingss=-1,this.minPacingmm=-1,this.minPacingss=-1,this.movingHH=0,this.movingmm=0,this.movingss=0,this.stepCount=0,this.calories=0,this.avgStride=-1,this.maxStride=-1,this.minStride=-1,this.avgCadence=-1,this.maxCadence=-1,this.minCadence=-1,this.leftBal=0,this.rightBal=0,this.avgHeartRate=-1,this.minHeartRate=-1,this.maxHeartRate=-1,this.pacingUnit="summary.per-km",this.distanceUnit="summary.km",this.strideUnit="summary.m",this.runningRoute=null,this.calculatedRoutes=[],this.markers=[],this.map=null,this.isImperial=!1,this.deleteActivity=()=>s.b(this,void 0,void 0,(function*(){if(null!=this.activity.activityId)try{yield this.popupCtrl.presentActionSheet({buttons:[{text:this.translate.instant("summary.delete-activity"),role:"destructive",handler:()=>{this.backend.removeActivity(this.activity.activityId).then(()=>{this.navCtrl.pop()}).catch(t=>{this.navCtrl.pop()})}},{text:this.translate.instant("global.cancel"),role:"cancel"}]},!0)}catch(t){console.log(t)}})),this.showRecycleBin=()=>null!=this.activity.activityId,this.openMap=()=>s.b(this,void 0,void 0,(function*(){if(null==this.map&&this.runningRoute.length>0)try{this.map=new google.maps.Map(this.mapCanvas.nativeElement,{center:{lat:this.runningRoute[0].lat,lng:this.runningRoute[0].lng},zoom:h,disableDefaultUI:!0}),this.updateRouteDisplay()}catch(t){console.log(t)}})),this.closeMap=()=>{null!=this.map&&(this.deleteRoute(),this.map=null)},this.deleteRoute=()=>{this.deleteMarkers();for(let t of this.calculatedRoutes)t.setMap(null);this.calculatedRoutes=[]},this.addMarker=(t,i)=>{let e;switch(i){case r.CURRENT:e="assets/imgs/blue-dot.png";break;case r.START:e="assets/imgs/green-dot.png";break;case r.STOP:default:e="assets/imgs/red-dot.png"}if(null!=this.map){let i=new google.maps.Marker({map:this.map,position:t,icon:{url:e}});this.markers.push(i)}},this.deleteMarkers=()=>{for(const t of this.markers)t.setMap(null);this.markers.length=0},this.drawPathOnMap=(t,i)=>{let e="#AA00FF";i||(e="#C0C0C0");const s=new google.maps.Polyline({path:t,geodesic:!0,strokeColor:e,strokeOpacity:1,strokeWeight:2});s.setMap(this.map),this.calculatedRoutes.push(s)},this.updateRouteDisplay=()=>{if(null!=this.map){let t=new google.maps.LatLngBounds,i=[],e=!1,s=null,a=null;for(let n of this.runningRoute)null==n.paused&&(n.paused=!1),null==s&&(s=n),a=n,i.push({lat:n.lat,lng:n.lng}),t.extend(new google.maps.LatLng(n.lat,n.lng)),e!=n.paused&&(this.drawPathOnMap(i,!e),i=[n],e=n.paused);i.length>1&&this.drawPathOnMap(i,!e),this.calculatedRoutes.length>0?(this.addMarker(s,r.START),this.addMarker(a,r.STOP),this.map.fitBounds(t)):this.addMarker(i[0],r.CURRENT)}},this.route.queryParams.subscribe(t=>{this.router.getCurrentNavigation().extras.state&&(this.activity=this.router.getCurrentNavigation().extras.state.activity)})}ngOnInit(){this.startDate=Object(n.b)(this.activity.startTime)+" "+Object(n.a)(this.activity.startTime),this.startTime=Object(n.d)(this.activity.startTime),this.coachSettings.getUnit()==a.d&&(this.pacingUnit="summary.per-mi",this.distanceUnit="summary.mile",this.strideUnit="summary.feet",this.isImperial=!0);let t=this.activity.elapsedTime;this.elapsedss=Math.floor(t%60),this.elapsedmm=Math.floor(t/60)%60,this.elapsedHH=Math.floor(t/3600),this.distance=this.activity.distance,this.isImperial&&(this.distance*=.62137);let i=this.activity.avgPacing,e=this.activity.maxPacing,s=this.activity.minPacing;this.isImperial&&(i/=.62137,e/=.62137,s/=.62137),this.avgPacingmm=Math.floor(i),this.avgPacingss=Math.floor(i%1*60),this.maxPacingmm=Math.floor(e),this.maxPacingss=Math.floor(e%1*60),this.minPacingmm=Math.floor(s),this.minPacingss=Math.floor(s%1*60);let h=this.activity.movingTime;this.movingss=Math.floor(h%60),this.movingmm=Math.floor(h/60)%60,this.movingHH=Math.floor(h/3600),this.stepCount=this.activity.stepCount,this.calories=this.activity.calories,this.avgStride=this.activity.avgStride,this.maxStride=this.activity.maxStride,this.minStride=this.activity.minStride,this.isImperial&&(this.avgStride*=3.2808,this.maxStride*=3.2808,this.minStride*=3.2808),this.avgCadence=this.activity.avgCadence,this.maxCadence=this.activity.maxCadence,this.minCadence=this.activity.minCadence,this.leftBal=this.activity.leftBalance,this.rightBal=this.activity.rightBalance,this.avgHeartRate=this.activity.avgHeartRate,this.minHeartRate=this.activity.minHeartRate,this.maxHeartRate=this.activity.maxHeartRate,this.runningRoute=this.activity.route}ionViewDidEnter(){this.openMap()}ionViewWillLeave(){this.closeMap()}}class o{constructor(){this.activityId=null,this.startTime=null,this.distance=0,this.elapsedTime=0,this.avgPacing=0,this.maxPacing=0,this.minPacing=0,this.movingTime=0,this.stepCount=0,this.calories=0,this.avgStride=0,this.maxStride=0,this.minStride=0,this.avgCadence=0,this.maxCadence=0,this.minCadence=0,this.leftBalance=0,this.rightBalance=0,this.avgHeartRate=0,this.minHeartRate=0,this.maxHeartRate=0,this.route=[]}}},"6mIw":function(t,i,e){"use strict";e.d(i,"b",(function(){return r})),e.d(i,"a",(function(){return c}));var s=e("mrSG"),a=e("lGdP"),n=e("R3bG"),h=e("yDgC");class r extends a.k{constructor(t,i,e,s){super(t,!0,!0,!1),this.maxNodAngle=i,this.maxNodTime=e,this.pitchReference=s}}class c extends a.j{constructor(t,i,e,h,r,c,o,l,u){super(i,e,h,r,c,o,l,u),this.acceDataXArray=[],this.acceDataYArray=[],this.acceDataZArray=[],this.clearAcceData=()=>{this.acceDataXArray=[],this.acceDataYArray=[],this.acceDataZArray=[]},this.handleGAMBack=t=>s.b(this,void 0,void 0,(function*(){const i=(new Date).getTime();if(0==this.lastTimeStamp)return void(this.lastTimeStamp=i);const e=i-this.lastTimeStamp;this.lastTimeStamp=i;const s=t.acceDataX,a=t.acceDataY;this.acceDataXArray.push(t.acceDataZ),this.acceDataYArray.push(-a),this.acceDataZArray.push(s),this.timerset.update(e)})),this.processPostureData=()=>s.b(this,void 0,void 0,(function*(){if(0==this.acceDataXArray.length||0==this.acceDataYArray.length||0==this.acceDataZArray.length)return;this.acceDataXArray.reduce((t,i)=>t+i,0);const t=this.acceDataYArray.reduce((t,i)=>t+i,0)/this.acceDataYArray.length,i=this.acceDataZArray.reduce((t,i)=>t+i,0)/this.acceDataZArray.length;this.clearAcceData();let e=Math.atan(t/i);e*=180/Math.PI,this.cfg.pitchReference-e<this.cfg.maxNodAngle?(this.correctPostureCnt++,this.instantIncorrectPostureCnt=0):(this.incorrectPostureCnt++,this.instantIncorrectPostureCnt++,this.instantIncorrectPostureCnt>=this.cfg.maxNodTime&&(this.instantIncorrectPostureCnt=0,this.getState()==a.i.Started&&(this.audioPlayer.flushPendingSpeech4tag(a.h),this.audioPlayer.speech(!0,this.translate.instant("training.keep-look-forward"),a.h))))})),this.startGAM=()=>{this.events.subscribe(n.c,this.handleGAMBack),this.solosConnector.startGAM().then(()=>{}).catch(t=>{console.log(t)})},this.stopGAM=()=>{this.events.unsubscribe(n.c,this.handleGAMBack),this.solosConnector.stopGAM().then(()=>{}).catch(t=>{console.log(t)})},this.cfg=t}start(t){return!!super.start(t)&&(this.lastTimeStamp=0,this.instantIncorrectPostureCnt=0,this.correctPostureCnt=0,this.incorrectPostureCnt=0,this.clearAcceData(),this.timerset=new h.a,this.timerset.addTimer(this.processPostureData,1e3),!0)}coachMetricDataChanged(){super.coachMetricDataChanged(),this.events.publish(a.a,this.getCoachMetricData())}getCoachMetricData(){return{movingTime:this.movingTime,distance:this.distance,correctPostureCnt:this.correctPostureCnt,incorrectPostureCnt:this.incorrectPostureCnt}}coachStarted(){this.startGAM(),super.coachStarted()}coachPaused(){this.stopGAM(),super.coachPaused()}coachStopped(){this.stopGAM(),super.coachStopped()}stopped(){let t=this.getSpokenTextWithMovingTime();this.audioPlayer.speech(!1,t),t=this.getSpokenTextTotalDistance(),this.audioPlayer.speech(!1,t),t=this.translate.instant("training.correct-posture-percent",{value:(this.correctPostureCnt+this.incorrectPostureCnt?100*this.correctPostureCnt/(this.correctPostureCnt+this.incorrectPostureCnt):0).toFixed(0)}),this.audioPlayer.speech(!1,t,"",()=>{super.stopped()})}}},BHc3:function(t,i,e){"use strict";var s=e("mrSG"),a=e("ZZ/e"),n=e("R3bG"),h=e("lIDq"),r=e("A5kO"),c=e("yDgC"),o=e("8qa8"),l=e("Z18M"),u=e("nJKE"),g=e("6gT1"),d=e("yM5c"),m=e("AGLQ"),p=e("PEy0"),v=e("uUwQ"),S=e("DaA9"),f=e("cPjO"),T=e("yYM5"),y=e("4SHv"),R=e("lvyt"),C=e("3Cwc"),P=e("ppcj");class b{constructor(t,i,e=2e3){this.append=t=>{this.logBuffer+=t+"\r\n",null===this.saveTimer&&(this.saveTimer=setTimeout(this.saveToFile,this.saveIntervalMS))},this.saveToFile=()=>s.b(this,void 0,void 0,(function*(){try{0!=this.logBuffer.length&&(yield this.file.appendTextFile(this.filename,this.logBuffer),this.logBuffer=""),this.saveTimer=null}catch(t){console.log(t)}})),this.file=t,this.filename=i,this.saveIntervalMS=e,this.logBuffer="",this.saveTimer=null}}var M=e("8Y7J"),D=e("TSSN");e.d(i,"i",(function(){return k})),e.d(i,"f",(function(){return A})),e.d(i,"e",(function(){return x})),e.d(i,"g",(function(){return I})),e.d(i,"h",(function(){return w})),e.d(i,"c",(function(){return L})),e.d(i,"d",(function(){return B})),e.d(i,"j",(function(){return Rt})),e.d(i,"a",(function(){return Ct})),e.d(i,"b",(function(){return bt}));const k="evtCoachStateChanged",A="evtCoachMetricChanged",x="evtCoachHeartRateChanged",I="evtCoachOneSecondTimer",w="evtCoachRouteChanged",L="evtCoachActivitySaved",B="evtCoachExternalReminder",O="AICoachRecord-",H=".ai",_=".strava",G="tagSpeechAICoachReminder",U=6e4,F=!1,W=!1,E=!1,N=!1,Z=!1,K=-1,Y=-1,X=-1,j=0,V=-1,q=0,J=0,Q=0,z=0,$=-1,tt=-1,it=-1,et=0,st=0,at=0,nt=0,ht=0,rt=0,ct=0,ot=0,lt=0,ut=0,gt=800,dt=6,mt=.12,pt=45,vt=.2,St=2,ft=5;var Tt=function(t){return t[t.Start=0]="Start",t[t.Stop=1]="Stop",t[t.Pause=2]="Pause",t[t.PauseOnDisconnect=3]="PauseOnDisconnect",t[t.Resume=4]="Resume",t[t.ResumeOnConnect=5]="ResumeOnConnect",t}({});class yt{constructor(t,i){this.type=t,this.para=i}}var Rt=function(t){return t[t.Idle=0]="Idle",t[t.Running=1]="Running",t[t.Paused=2]="Paused",t[t.Busy=3]="Busy",t}({}),Ct=function(t){return t[t.Running=0]="Running",t[t.Walking=1]="Walking",t}({});class Pt{constructor(t,i,e,s,a){this.timeISO=t,this.lon=i,this.lat=e,this.hr=s,this.cad=a}}let bt=(()=>{class t{constructor(t,i,e,a,r,o,d,m,p,v,S,f,M,D,dt){this.solosConnector=t,this.events=i,this.coachSettings=e,this.translate=a,this.platform=r,this.audioPlayer=o,this.backend=d,this.location=m,this.background=p,this.fileUtility=v,this.algo=S,this.postureSettings=f,this.heartRateDevice=M,this.stravaService=D,this.trainingSettings=dt,this.state=Rt.Idle,this.walkingStateTimeout=null,this.runningStateTimeout=null,this.elapsedTimers=null,this.movingTimers=null,this.reminderTimer=null,this.training=!1,this.stravaInitedEventSubscribed=!1,this.initVars=(t=!1,i=Ct.Running,e=!0)=>{this.activityType=i,this.runningState=!1,this.walkingState=!1,this.walkingStateTimeout=null,this.runningStateTimeout=null,this.startTime=new Date,this.lastTimeStamp=this.startTime.getTime(),this.cumulatedTimeStamp=0,this.elapsedTimers=null,this.movingTimers=null,this.totalDistance=q,this.currCadence=X,this.maxCadence=X,this.minCadence=X,this.currPacing=K,this.minPacing=K,this.maxPacing=K,this.movingTimeAlwaysOn=!1,this.ignoreFirstMovingTimeUpdate=!1,this.movingTime=j,this.currStride=V,this.maxStride=V,this.minStride=V,this.lastStepCount=0,this.stepCount=Y,this.L_counter=Array(600).fill(1),this.R_counter=Array(600).fill(1),this.total_L_counter=J,this.total_R_counter=Q,this.M_time=z,this.L_ratio=$,this.R_ratio=tt,this.M_ratio=it,this.useGPS=e,this.positionSubscription=null,this.calculatedGPSArray=[],this.gpxDataArray=[],this.resetAlgo(),this.sampleArray=[],this.gyroDataX=st,this.gyroDataY=at,this.gyroDataZ=nt,this.acceDataX=ht,this.acceDataY=rt,this.acceDataZ=ct,this.magnDataX=ot,this.magnDataY=lt,this.magnDataZ=ut,this.totalCalories=et,this.lastCaloriesCalculationDistance=0,this.lastCaloriesCalculationSteps=0,this.lastCaloriesCalculationTS=0,this.elevation=0,this.currHeartRate=0,this.lastHeartRate=0,this.lastHeartRateTS=0,this.heartRates=[],this.training=t,this.logGPSData=this.backend.getCoachLogEnabled(this.backend.getLoginUser()),this.localRecordFilename=this.getNowLocalRecordFilename(),this.uploadRecordsTimer=null;const s=this.startTime.getFullYear().toString()+("0"+(this.startTime.getMonth()+1)).slice(-2)+("0"+this.startTime.getDate()).slice(-2)+"-"+("0"+this.startTime.getHours()).slice(-2)+("0"+this.startTime.getMinutes()).slice(-2)+("0"+this.startTime.getSeconds()).slice(-2);this.originalGPSFileLog=new b(this.fileUtility,s+"-OriginalGPS.txt"),this.stepCountFileLog=new b(this.fileUtility,s+"-StepCount.txt"),this.gamFileLog=new b(this.fileUtility,s+"-GAM.txt"),this.LRreferenceFileLog=new b(this.fileUtility,s+"-LRreference.txt"),this.runningStateFileLog=new b(this.fileUtility,s+"-runningState.txt"),this.heartRateFileLog=new b(this.fileUtility,s+"-heartRate.txt")},this.resetAlgo=()=>{this.algo.initMetrics(),this.lastGPSLoc=null},this.isTraining=()=>this.training,this.speakStartActivity=()=>{this.isTraining()?this.setState(Rt.Running):(this.background.enable(),this.audioPlayer.speech(!0,this.translate.instant("ai-coach.activity-started"),"",()=>{this.setState(Rt.Running)}))},this.speakStopActivity=()=>{this.isTraining()?this.setState(Rt.Idle):(this.audioPlayer.flushPendingSpeech4tag(G),this.audioPlayer.speech(!0,this.translate.instant("ai-coach.activity-ended"),"",()=>{this.runCoachReminder(!0,()=>{this.background.disable(),this.setState(Rt.Idle)})}))},this.speakResumeActivity=()=>{this.isTraining()?this.setState(Rt.Running):(this.audioPlayer.flushPendingSpeech(),this.audioPlayer.speech(!0,this.translate.instant("ai-coach.activity-resumed"),"",()=>{this.setState(Rt.Running)}))},this.speakPauseActivity=()=>{this.isTraining()?this.setState(Rt.Paused):(this.audioPlayer.flushPendingSpeech(),this.audioPlayer.speech(!0,this.translate.instant("ai-coach.activity-paused"),"",()=>{this.setState(Rt.Paused)}))},this.startSensors=(t=!1,i=!1)=>s.b(this,void 0,void 0,(function*(){try{t||this.useGPS&&(this.positionSubscription=this.location.startWatchPosition().subscribe(t=>{this.handleGPSUpdate(t)})),this.events.subscribe(T.a,this.onHeartRateDeviceConnected),this.events.subscribe(T.b,this.onHeartRateDeviceDisconnected),this.events.subscribe(T.c,this.onHeartRateChanged),this.heartRateDevice.startHeartRateStreaming(),yield this.solosConnector.resetStepCount(),this.events.subscribe(h.b,this.handleCoachIntervalChanged),this.events.subscribe(C.a,this.handleTrainingIntervalChanged),t&&!i||(this.events.subscribe(n.c,this.handleGAMBack),yield this.solosConnector.startGAM(),i&&(this.ignoreFirstMovingTimeUpdate=!0)),yield this.solosConnector.startStepCount(t=>{this.handleStepCount(t)})}catch(e){throw e}})),this.stopSensors=(t=!1,i=!1)=>s.b(this,void 0,void 0,(function*(){try{t||null!=this.positionSubscription&&(this.location.stopWatchPosition(this.positionSubscription),this.positionSubscription=null),this.events.unsubscribe(T.a,this.onHeartRateDeviceConnected),this.events.unsubscribe(T.b,this.onHeartRateDeviceDisconnected),this.events.unsubscribe(T.c,this.onHeartRateChanged),this.heartRateDevice.stopHeartRateStreaming(),this.events.unsubscribe(h.b,this.handleCoachIntervalChanged),this.events.unsubscribe(C.a,this.handleTrainingIntervalChanged);try{yield this.solosConnector.stopStepCount()}catch(e){console.log(e)}if(!t||i){this.events.unsubscribe(n.c,this.handleGAMBack);try{yield this.solosConnector.stopGAM()}catch(e){console.log(e)}}yield this.solosConnector.setTapSensitivity(this.solosConnector.getDefaultTapSensitivity())}catch(e){console.log(e)}})),this.start=(t=!1,i=Ct.Running,e=!0)=>{this.commandQueue.tryRun(new yt(Tt.Start,{training:t,activityType:i,useGPS:e}))},this.startInternal=t=>s.b(this,void 0,void 0,(function*(){try{if(this.state!=Rt.Idle)return;if(null==this.solosConnector.getConnectedDevice())return;const i=t.training,e=t.activityType,s=t.useGPS;this.setState(Rt.Busy),this.initVars(i,e,s),this.elapsedTimers=new c.a,this.movingTimers=new c.a,this.elapsedTimers.addTimer(this.publishOneSecondTimer,1e3),this.elapsedTimers.addTimer(this.calculateCalories,6e4),this.elapsedTimers.addTimer(this.saveLocalRecord,1e4),this.reminderTimer=this.isTraining()?this.movingTimers.addTimer(this.runExternalCoachReminderInTimer,60*this.trainingSettings.getReminderInterval()*1e3):this.elapsedTimers.addTimer(this.runCoachReminderInTimer,1e3*this.coachSettings.getReminderInterval()),yield this.startSensors(),this.events.subscribe(n.g,this.handleSlidePause),this.stopUploadRecords(),this.speakStartActivity()}catch(i){console.log(i),yield this.stopSensors(),this.setState(Rt.Idle)}})),this.stop=()=>{this.commandQueue.tryRun(new yt(Tt.Stop))},this.stopInternal=()=>s.b(this,void 0,void 0,(function*(){try{if(this.state!=Rt.Running&&this.state!=Rt.Paused)return;this.setState(Rt.Busy),yield this.stopSensors(),this.events.unsubscribe(n.g,this.handleSlidePause),yield this.saveLocalRecord(),this.uploadRecords(),this.speakStopActivity();const t=yield this.getActivityMetrics(),i=new g.a;i.activityId=null,i.startTime=this.startTime,i.distance=t.distance,i.elapsedTime=t.elapsedTime,i.avgPacing=t.avgPace,i.maxPacing=t.maxPace,i.minPacing=t.minPace,i.movingTime=t.movingTime,i.stepCount=t.stepCount,i.calories=t.calories,i.avgStride=t.avgStride,i.maxStride=t.maxStride,i.minStride=t.minStride,i.avgCadence=t.avgCadence,i.maxCadence=t.maxCadence,i.minCadence=t.minCadence,i.leftBalance=t.avgLeftBalance,i.rightBalance=t.avgRightBalance,i.avgHeartRate=t.avgHeartRate,i.minHeartRate=t.minHeartRate,i.maxHeartRate=t.maxHeartRate,i.route=t.route,this.events.publish(L,{activity:i})}catch(t){console.log(t)}})),this.pause=()=>{this.commandQueue.tryRun(new yt(Tt.Pause))},this.pauseInternal=(t=!1)=>s.b(this,void 0,void 0,(function*(){try{if(this.state!=Rt.Running)return;this.setState(Rt.Busy),this.stopRunningStateTimer(),this.stopRunningState(),this.stopWalkingStateTimer(),this.stopWalkingState(),this.calculatedGPSArray.length>0&&(this.calculatedGPSArray[this.calculatedGPSArray.length-1].paused=!0),this.resetAlgo(),yield this.stopSensors(!0,t),this.speakPauseActivity()}catch(i){console.log(i),this.speakPauseActivity()}})),this.resume=()=>{this.commandQueue.tryRun(new yt(Tt.Resume))},this.resumeInternal=(t=!1)=>s.b(this,void 0,void 0,(function*(){try{if(this.state!=Rt.Paused)return;if(null==this.solosConnector.getConnectedDevice())return;this.setState(Rt.Busy),yield this.startSensors(!0,t),this.speakResumeActivity()}catch(i){console.log(i),yield this.stopSensors(),this.setState(Rt.Paused)}})),this.isRunning=()=>this.state==Rt.Running||this.state==Rt.Paused||this.state==Rt.Busy,this.isPaused=()=>this.state==Rt.Paused,this.isBusy=()=>this.state==Rt.Busy,this.getRunTime=()=>this.isRunning()?this.cumulatedTimeStamp:0,this.getCalculatedRoute=()=>this.calculatedGPSArray,this.getPacing=()=>{if(this.currPacing==K)return this.currPacing;if(this.currPacing==this.algo.PACING_LIMIT)return K;{let t=this.currPacing;return this.coachSettings.getUnit()==h.d&&(t/=.62137),t}},this.getStepCount=()=>this.stepCount,this.getCadence=()=>this.currCadence,this.getMovingTime=()=>this.movingTime,this.setMovingTimeAlwaysOn=t=>{this.movingTimeAlwaysOn=t},this.getStride=()=>{if(this.currStride==V)return this.currStride;{let t=this.currStride;return this.coachSettings.getUnit()==h.d&&(t*=3.2808),t}},this.getDistance=()=>{let t=this.totalDistance;return this.coachSettings.getUnit()==h.d&&(t*=.62137),t},this.getLeftRatio=()=>this.L_ratio,this.getRightRatio=()=>this.R_ratio,this.getMiddleRatio=()=>this.M_ratio,this.getCalories=()=>Math.round(this.totalCalories),this.onHeartRateDeviceConnected=t=>{this.currHeartRate=0,this.lastHeartRate=0,this.lastHeartRateTS=0,this.heartRateDevice.startHeartRateStreaming(),this.events.publish(x,{heartRate:this.currHeartRate})},this.onHeartRateDeviceDisconnected=t=>{this.currHeartRate=0,this.lastHeartRate=0,this.lastHeartRateTS=0,this.events.publish(x,{heartRate:this.currHeartRate})},this.onHeartRateChanged=t=>{this.currHeartRate=t.heartRate,this.currHeartRate>0&&this.heartRates.push(this.currHeartRate),this.saveHeartRate(this.cumulatedTimeStamp,this.currHeartRate),this.calculateHeartRateCalories(),this.events.publish(x,{heartRate:this.currHeartRate})},this.getHeartRate=()=>this.currHeartRate,this.setState=t=>{t!=this.state&&(this.state=t,this.events.publish(k,{state:t}),this.state!=Rt.Busy&&this.commandQueue.runPendingCommands())},this.evtSolosDisconnected=t=>{this.commandQueue.tryRun(new yt(Tt.PauseOnDisconnect))},this.evtSolosConnected=t=>{this.commandQueue.tryRun(new yt(Tt.ResumeOnConnect))},this.handleSlidePause=()=>{this.isPaused()?this.resume():this.pause()},this.isAutoPause=()=>this.isTraining()?this.trainingSettings.getAutoPauseOn():this.coachSettings.getCoachAutoPauseOn(),this.handleGAMBack=t=>{const i=(new Date).getTime(),e=i-this.lastTimeStamp;if(this.lastTimeStamp=i,this.cumulatedTimeStamp+=e,this.elapsedTimers.update(e),this.state!=Rt.Paused){let t=!1;this.ignoreFirstMovingTimeUpdate?this.ignoreFirstMovingTimeUpdate=!1:this.isAutoPause()?this.runningState||this.walkingState?t=!0:this.movingTimeAlwaysOn&&(t=!0):t=!0,t&&(this.movingTime+=e,this.movingTimers.update(e))}if(this.state!=Rt.Running)return void this.publishMetricDataChangedEvent();this.gyroDataX=t.gyroDataX,this.gyroDataY=t.gyroDataY,this.gyroDataZ=t.gyroDataZ,this.acceDataX=t.acceDataX,this.acceDataY=t.acceDataY,this.acceDataZ=t.acceDataZ,this.magnDataX=t.magnDataX,this.magnDataY=t.magnDataY,this.magnDataZ=t.magnDataZ,this.saveGAM(this.cumulatedTimeStamp,this.gyroDataX,this.gyroDataY,this.gyroDataZ,this.acceDataX,this.acceDataY,this.acceDataZ,this.magnDataX,this.magnDataY,this.magnDataZ,e);const{Agx:s,Agy:a,Agz:n,Bax:h,Bay:r,Baz:c}=this.solosConnector.getCalibratedGAM(this.acceDataX,this.acceDataY,this.acceDataZ,this.gyroDataX,this.gyroDataY,this.gyroDataZ,this.magnDataX,this.magnDataY,this.magnDataZ),o=Math.atan2(a,n),l=Math.atan(-s/(n*Math.cos(o)+a*Math.sin(o))),u=Math.atan2(c*Math.sin(o)-r*Math.cos(o),h*Math.cos(l)+r*Math.sin(l)*Math.sin(o)-c*Math.sin(l)*Math.cos(o)),g=Math.cos(u)*Math.cos(o)+Math.sin(o)*Math.sin(l)*Math.sin(u),d=Math.cos(u)*Math.sin(l)*Math.sin(o)-Math.cos(o)*Math.sin(u),m=-Math.cos(l)*Math.sin(o);if(this.elevation=180*Math.atan(m/Math.sqrt(Math.pow(g,2)+Math.pow(d,2)))/Math.PI,this.sampleArray.push(n),this.sampleArray.length>15){const t=Array.from(this.sampleArray);this.sampleArray.shift(),this.findWalkingState(t)&&Math.abs(this.elevation)<45&&(this.startWalkingStateTimer(),this.walkingState=!0),this.findRunningState(t)&&Math.abs(this.elevation)<45&&(this.startRunningStateTimer(),this.runningState=!0)}if(this.runningState||this.walkingState){const i=t.acceDataZ,e=t.acceDataX;let s,a=this.postureSettings.getRollReference(),n=Math.atan(i/e);if(n*=180/Math.PI,null!=a){let t=n-a;s=n-a>ft?{LR:1,angle:t}:n-a<-ft?{LR:-1,angle:-t}:{LR:0,angle:t}}else s={LR:n>=0?1:-1,angle:n};1==s.LR?(this.L_counter.push(1),this.R_counter.push(0),this.L_counter.shift(),this.R_counter.shift(),this.total_L_counter+=1):-1==s.LR?(this.L_counter.push(0),this.R_counter.push(1),this.L_counter.shift(),this.R_counter.shift(),this.total_R_counter+=1):0==s.LR&&(this.L_counter.push(1),this.R_counter.push(1),this.L_counter.shift(),this.R_counter.shift(),this.total_L_counter+=.5,this.total_R_counter+=.5);let h=this.L_counter.filter(t=>t>0),r=this.R_counter.filter(t=>t>0),c=h.length,o=r.length;if(this.L_ratio=c/(c+o),this.R_ratio=o/(c+o),this.runningState){let t=this.solosConnector.getDefaultTapSensitivity()+12;t>this.solosConnector.getMaxTapSensitivity()&&(t=this.solosConnector.getMaxTapSensitivity()),this.solosConnector.setTapSensitivity(t)}}else this.L_ratio=$,this.R_ratio=tt,this.solosConnector.setTapSensitivity(this.solosConnector.getDefaultTapSensitivity());this.saveRunningState(this.cumulatedTimeStamp,this.walkingState,this.runningState),this.publishMetricDataChangedEvent()},this.startWalkingStateTimer=()=>{this.stopWalkingStateTimer(),this.walkingStateTimeout=this.elapsedTimers.addTimer(this.stopWalkingState,gt,!0)},this.stopWalkingStateTimer=()=>{null!=this.walkingStateTimeout&&(this.elapsedTimers.removeTimer(this.walkingStateTimeout),this.walkingStateTimeout=null)},this.startRunningStateTimer=()=>{this.stopRunningStateTimer(),this.runningStateTimeout=this.elapsedTimers.addTimer(this.stopRunningState,gt,!0)},this.stopRunningStateTimer=()=>{null!=this.runningStateTimeout&&(this.elapsedTimers.removeTimer(this.runningStateTimeout),this.runningStateTimeout=null)},this.stopWalkingState=()=>s.b(this,void 0,void 0,(function*(){this.walkingState=!1})),this.stopRunningState=()=>s.b(this,void 0,void 0,(function*(){this.runningState=!1})),this.handleStepCount=t=>{let i=t.stepCount-this.lastStepCount;i<0&&(i=t.stepCount),this.lastStepCount=t.stepCount,this.state==Rt.Running&&(this.stepCount==Y&&(this.stepCount=0),this.stepCount+=i,this.saveStepCount(this.cumulatedTimeStamp,this.stepCount),this.publishMetricDataChangedEvent())},this.handleGPSUpdate=t=>{if(this.state!=Rt.Running)return;this.lastGPSLoc=new u.b(t.coords.latitude,t.coords.longitude),this.saveOriginalGPS(this.cumulatedTimeStamp,t.coords.latitude,t.coords.longitude);const i=this.algo.calculateMetrics(this.cumulatedTimeStamp,t.coords.latitude,t.coords.longitude,this.stepCount,this.gyroDataX,this.gyroDataY,this.gyroDataZ,this.acceDataX,this.acceDataY,this.acceDataZ,this.magnDataX,this.magnDataY,this.magnDataZ,this.walkingState?1:0,this.runningState?1:0);null!=i&&(this.totalDistance+=i.deltaD/1e3,this.currPacing=i.pacing,this.currCadence=Math.round(60*i.cadence),this.currStride=i.stride,this.walkingState||this.runningState?(this.currPacing!=this.algo.PACING_LIMIT&&(this.maxPacing!=K&&this.minPacing!=K||(this.maxPacing=this.currPacing,this.minPacing=this.currPacing),this.maxPacing=Math.max(this.currPacing,this.maxPacing),this.minPacing=Math.min(this.currPacing,this.minPacing)),0!=this.currCadence&&(this.maxCadence!=X&&this.minCadence!=X||(this.maxCadence=this.currCadence,this.minCadence=this.currCadence),this.maxCadence=Math.max(this.maxCadence,this.currCadence),this.minCadence=Math.min(this.minCadence,this.currCadence)),0!=this.currStride&&(this.maxStride!=V&&this.minStride!=V||(this.maxStride=this.currStride,this.minStride=this.currStride),this.maxStride=Math.max(this.maxStride,this.currStride),this.minStride=Math.min(this.minStride,this.currStride)),i.isValidPoint&&this.calculatedGPSArray.push(this.lastGPSLoc)):(this.currPacing=K,this.currCadence=X,this.currStride=V),(this.isTraining()&&this.trainingSettings.getUploadStrava()||!this.isTraining())&&this.gpxDataArray.push(new Pt((new Date).toISOString(),t.coords.longitude,t.coords.latitude,this.currHeartRate,this.currCadence)),this.publishMetricDataChangedEvent(),this.publishRouteChangedEvent())},this.calculateHeartRateCalories=()=>{if(this.state==Rt.Running){if(0!=this.lastHeartRate&&0!=this.lastHeartRateTS){let t=void 0,i=0,e=0;const s=this.backend.getLoginUser();null!=s&&(this.backend.getGender(s)!=l.b.Unknown&&(t=this.backend.getGender(s)==l.b.Male),i=this.backend.getWeight(s),e=this.backend.getAge(s)),this.totalCalories+=this.algo.getHeartRateCalories(t,i,e,this.cumulatedTimeStamp-this.lastHeartRateTS,this.lastHeartRate)}this.lastHeartRate=this.currHeartRate,this.lastHeartRateTS=this.cumulatedTimeStamp}else this.lastHeartRate=0,this.lastHeartRateTS=0},this.calculateCalories=()=>s.b(this,void 0,void 0,(function*(){if(this.state==Rt.Running&&null==this.heartRateDevice.getConnectedDeviceId()){let t=void 0,i=0,e=0,s=0;const a=this.backend.getLoginUser();null!=a&&(this.backend.getGender(a)!=l.b.Unknown&&(t=this.backend.getGender(a)==l.b.Male),i=this.backend.getWeight(a),e=this.backend.getHeight(a),s=this.backend.getAge(a)),this.totalCalories+=this.activityType==Ct.Running?this.algo.getRunningCalories(t,i,e,s,this.cumulatedTimeStamp-this.lastCaloriesCalculationTS,this.totalDistance-this.lastCaloriesCalculationDistance):this.algo.getStepsCalories(t,i,e,s,this.cumulatedTimeStamp-this.lastCaloriesCalculationTS,this.stepCount-this.lastCaloriesCalculationSteps)}this.lastCaloriesCalculationDistance=this.totalDistance,this.lastCaloriesCalculationSteps=this.stepCount,this.lastCaloriesCalculationTS=this.cumulatedTimeStamp})),this.publishRouteChangedEvent=()=>{this.events.publish(w,{calculatedRoute:this.calculatedGPSArray})},this.publishMetricDataChangedEvent=()=>{this.events.publish(A)},this.publishOneSecondTimer=()=>s.b(this,void 0,void 0,(function*(){this.events.publish(I)})),this.handleCoachIntervalChanged=()=>{null==this.reminderTimer||this.isTraining()||this.elapsedTimers.changeInterval(this.reminderTimer,1e3*this.coachSettings.getReminderInterval())},this.handleTrainingIntervalChanged=()=>{null!=this.reminderTimer&&this.isTraining()&&this.movingTimers.changeInterval(this.reminderTimer,60*this.trainingSettings.getReminderInterval()*1e3)},this.runExternalCoachReminderInTimer=()=>s.b(this,void 0,void 0,(function*(){this.state==Rt.Running&&this.events.publish(B)})),this.runCoachReminderInTimer=()=>s.b(this,void 0,void 0,(function*(){this.state==Rt.Running&&this.runCoachReminder()})),this.runCoachReminder=(t=!1,i)=>{let e=[];if(this.coachSettings.getReminderTypeElapsedTimeOn()){const t=this.getSpokenTextElapsedTime();null!=t&&e.push(t)}if(this.coachSettings.getReminderTypeDistanceOn()){const t=this.getSpokenTextDistance();null!=t&&e.push(t)}if(this.coachSettings.getReminderTypePacingOn()&&!t){const t=this.getSpokenTextPacing();null!=t&&e.push(t)}if(this.coachSettings.getReminderTypeAveragePacingOn()){const t=this.getSpokenTextAvgPacing();null!=t&&e.push(t)}if(this.coachSettings.getReminderTypeMovingTimeOn()){const t=this.getSpokenTextMovingTime();null!=t&&e.push(t)}if(this.coachSettings.getReminderTypeStepCountOn()){const t=this.getSpokenTextStepCount();null!=t&&e.push(t)}if(this.coachSettings.getReminderHeartRateTypeOn()&&!t){const t=this.getSpokenTextHeartRate();null!=t&&e.push(t)}if(this.coachSettings.getReminderTypeStrideOn()&&!t){const t=this.getSpokenTextStride();null!=t&&e.push(t)}if(this.coachSettings.getReminderTypeAverageStrideOn()){const t=this.getSpokenTextAvgStride();null!=t&&e.push(t)}if(this.coachSettings.getReminderTypeCadenceOn()&&!t){const t=this.getSpokenTextCadence();null!=t&&e.push(t)}if(this.coachSettings.getReminderTypeAverageCadenceOn()){const t=this.getSpokenTextAvgCadence();null!=t&&e.push(t)}if(this.coachSettings.getReminderTypeLeftBalanceOn()&&!t){const t=this.getSpokenTextLeftBalance();null!=t&&e.push(t)}if(this.coachSettings.getReminderTypeRightBalanceOn()&&!t){const t=this.getSpokenTextRightBalance();null!=t&&e.push(t)}if(this.coachSettings.getReminderTypeLeftBalanceOn()&&t){const t=this.getSpokenTextAvgLeftBalance();null!=t&&e.push(t)}if(this.coachSettings.getReminderTypeRightBalanceOn()&&t){const t=this.getSpokenTextAvgRightBalance();null!=t&&e.push(t)}if(e.length)for(let s=0;s<e.length;s++)t||0!=s?s==e.length-1?this.audioPlayer.speech(!1,e[s],G,i):this.audioPlayer.speech(!1,e[s],G):this.audioPlayer.speech(!0,e[s],G);else void 0!==i&&i()},this.getSpokenTextHeartRate=()=>this.currHeartRate>0?this.translate.instant("ai-coach.heart-rate-is",{value:this.currHeartRate}):null,this.getSpokenTextPacing=()=>{let t=this.currPacing;if(t<0)return null;this.coachSettings.getUnit()==h.d&&(t/=.62137);const i=Math.floor(t).toString(),e=Math.floor(t%1*60).toString();return this.coachSettings.getUnit()==h.d?this.translate.instant("ai-coach.pacing-is-full-mile",{min:i,sec:e}):this.translate.instant("ai-coach.pacing-is-full-km",{min:i,sec:e})},this.getSpokenTextAvgPacing=()=>{let t=0!=this.totalDistance?this.movingTime/1e3/60/this.totalDistance:K;if(t<=0)return null;this.coachSettings.getUnit()==h.d&&(t/=.62137);const i=Math.floor(t).toString(),e=Math.floor(t%1*60).toString();return this.coachSettings.getUnit()==h.d?this.translate.instant("ai-coach.avg-pacing-is-full-mile",{min:i,sec:e}):this.translate.instant("ai-coach.avg-pacing-is-full-km",{min:i,sec:e})},this.getSpokenTextElapsedTime=()=>{const t=Math.floor(this.cumulatedTimeStamp/1e3%60),i=Math.floor(this.cumulatedTimeStamp/1e3/60)%60,e=Math.floor(this.cumulatedTimeStamp/1e3/3600);let s=null;return e<1?i<1?t>0&&(s=this.translate.instant("ai-coach.elapsed-time-is")+" "+t+this.translate.instant("ai-coach.seconds")):s=t>0?this.translate.instant("ai-coach.elapsed-time-is")+" "+i+" "+this.translate.instant("ai-coach.minutes-and")+" "+t+" "+this.translate.instant("ai-coach.seconds"):this.translate.instant("ai-coach.elapsed-time-is")+" "+i+" "+this.translate.instant("ai-coach.minutes"):s=i<1?t>0?this.translate.instant("ai-coach.elapsed-time-is")+" "+e+" "+this.translate.instant("ai-coach.hours-and")+" "+t+" "+this.translate.instant("ai-coach.seconds"):this.translate.instant("ai-coach.elapsed-time-is")+" "+e+" "+this.translate.instant("ai-coach.hours"):t>0?this.translate.instant("ai-coach.elapsed-time-is")+" "+e+" "+this.translate.instant("ai-coach.hours")+i+" "+this.translate.instant("ai-coach.minutes-and")+" "+t+" "+this.translate.instant("ai-coach.seconds"):this.translate.instant("ai-coach.elapsed-time-is")+" "+e+" "+this.translate.instant("ai-coach.hours")+i+" "+this.translate.instant("ai-coach.minutes"),s},this.getSpokenTextDistance=()=>{let t=this.totalDistance;return this.coachSettings.getUnit()==h.d&&(t*=.62137),this.translate.instant("ai-coach.distance-is")+" "+t.toFixed(2)+this.translate.instant(this.coachSettings.getUnit()==h.d?"ai-coach.miles":"ai-coach.k-m")},this.getSpokenTextMovingTime=(t=!1)=>{let i=Math.floor(this.movingTime/1e3);const e=Math.floor(i%60),s=Math.floor(i/60%60),a=Math.floor(i/3600);let n=null;return a<1?s<1?e>0?n=this.translate.instant("ai-coach.moving-time-is")+" "+e+this.translate.instant("ai-coach.seconds"):t&&(n=this.translate.instant("ai-coach.moving-time-is")+" "+e+this.translate.instant("ai-coach.seconds")):n=e>0?this.translate.instant("ai-coach.moving-time-is")+" "+s+" "+this.translate.instant("ai-coach.minutes-and")+" "+e+" "+this.translate.instant("ai-coach.seconds"):this.translate.instant("ai-coach.moving-time-is")+" "+s+" "+this.translate.instant("ai-coach.minutes"):n=s<1?e>0?this.translate.instant("ai-coach.moving-time-is")+" "+a+" "+this.translate.instant("ai-coach.hours-and")+" "+e+" "+this.translate.instant("ai-coach.seconds"):this.translate.instant("ai-coach.moving-time-is")+" "+a+" "+this.translate.instant("ai-coach.hours"):e>0?this.translate.instant("ai-coach.moving-time-is")+" "+a+" "+this.translate.instant("ai-coach.hours")+s+" "+this.translate.instant("ai-coach.minutes-and")+" "+e+" "+this.translate.instant("ai-coach.seconds"):this.translate.instant("ai-coach.moving-time-is")+" "+a+" "+this.translate.instant("ai-coach.hours")+s+" "+this.translate.instant("ai-coach.minutes"),n},this.getSpokenTextStepCount=(t=!1)=>{let i=this.stepCount;if(i<0){if(!t)return null;i=0}return this.translate.instant("ai-coach.step-count-is")+" "+i},this.getSpokenTextStride=()=>{let t=this.currStride;return t<0?null:(this.coachSettings.getUnit()==h.d&&(t*=3.2808),this.translate.instant("ai-coach.stride-is")+" "+t.toFixed(2)+this.translate.instant(this.coachSettings.getUnit()==h.d?"ai-coach.feet":"ai-coach.meter"))},this.getSpokenTextAvgStride=()=>{let t=0!=this.stepCount?1e3*this.totalDistance/this.stepCount:V;return t<=0?null:(this.coachSettings.getUnit()==h.d&&(t*=3.2808),this.translate.instant("ai-coach.avg-stride-is")+" "+t.toFixed(2)+this.translate.instant(this.coachSettings.getUnit()==h.d?"ai-coach.feet":"ai-coach.meter"))},this.getSpokenTextCadence=()=>{let t=this.currCadence;return t<=0?null:this.translate.instant("ai-coach.cadence-is-full",{value:t.toFixed(0)})},this.getSpokenTextAvgCadence=()=>{let t=0!=this.movingTime?this.stepCount/(this.movingTime/1e3/60):X;return t<=0?null:this.translate.instant("ai-coach.avg-cadence-is-full",{value:t.toFixed(0)})},this.getSpokenTextLeftBalance=()=>{let t=Math.round(100*this.L_ratio);return t<0?null:this.translate.instant("ai-coach.curr-left-bal-is",{value:t})},this.getSpokenTextRightBalance=()=>{let t=Math.round(100*this.R_ratio);return t<0?null:this.translate.instant("ai-coach.curr-right-bal-is",{value:t})},this.getSpokenTextAvgLeftBalance=()=>{let t=$;0==this.total_L_counter&&0==this.total_R_counter||(t=this.total_L_counter/(this.total_L_counter+this.total_R_counter));let i=Math.round(100*t);return i<0?null:this.translate.instant("ai-coach.avg-left-bal-is",{value:i})},this.getSpokenTextAvgRightBalance=()=>{let t=$;0==this.total_L_counter&&0==this.total_R_counter||(t=this.total_R_counter/(this.total_L_counter+this.total_R_counter));let i=Math.round(100*t);return i<0?null:this.translate.instant("ai-coach.avg-right-bal-is",{value:i})},this.getActivityMetrics=()=>s.b(this,void 0,void 0,(function*(){try{let t=[];if(this.calculatedGPSArray.length&&(t=Array.from(this.calculatedGPSArray)),t.length<2)if(null!=this.lastGPSLoc)t.push(this.lastGPSLoc);else{const i=yield this.location.getCurrentPosition();t.push(void 0!==i?new u.b(i.coords.latitude,i.coords.longitude):new u.b(22.42427,114.21419))}let i=0!=this.totalDistance?this.movingTime/1e3/60/this.totalDistance:K;i>=this.algo.PACING_LIMIT&&(i=this.algo.PACING_LIMIT);let e=0!=this.stepCount?1e3*this.totalDistance/this.stepCount:V;e>=St&&(e=St);let s=0,a=0,n=0;this.heartRates.length>0&&(s=Math.round(this.heartRates.reduce((t,i)=>t+i,0)/this.heartRates.length),n=Math.max.apply(Math,this.heartRates),a=Math.min.apply(Math,this.heartRates));let h=$,r=tt;0==this.total_L_counter&&0==this.total_R_counter||(h=this.total_L_counter/(this.total_L_counter+this.total_R_counter),r=this.total_R_counter/(this.total_L_counter+this.total_R_counter));const c=this.getCalories();return{elapsedTime:this.cumulatedTimeStamp/1e3,distance:this.totalDistance,stepCount:this.stepCount,avgPace:i,minPace:this.minPacing,maxPace:this.maxPacing,movingTime:this.movingTime/1e3,avgStride:e,minStride:this.minStride,maxStride:this.maxStride,avgCadence:0!=this.movingTime?Math.round(this.stepCount/(this.movingTime/1e3/60)):X,minCadence:this.minCadence,maxCadence:this.maxCadence,avgLeftBalance:h,avgRightBalance:r,calories:c,avgHeartRate:s,minHeartRate:a,maxHeartRate:n,route:t}}catch(t){console.log(t)}})),this.getNowLocalRecordFilename=()=>{const t=Object(R.c)(new Date);return O+t},this.uploadPendingRecords=()=>s.b(this,void 0,void 0,(function*(){try{this.stravaService.inited()?(this.stravaInitedEventSubscribed&&(this.stravaInitedEventSubscribed=!1,this.events.unsubscribe(y.a,this.uploadPendingRecords)),this.isRunning()||(yield this.uploadRecords())):this.stravaInitedEventSubscribed||(this.stravaInitedEventSubscribed=!0,this.events.subscribe(y.a,this.uploadPendingRecords))}catch(t){console.log(t.message)}})),this.stopUploadRecords=()=>{null!=this.uploadRecordsTimer&&(clearTimeout(this.uploadRecordsTimer),this.uploadRecordsTimer=null)},this.uploadRecords=()=>s.b(this,void 0,void 0,(function*(){try{this.background.enable();let t=yield this.fileUtility.listFiles(H);for(const s of t)yield this.uploadAiRecord(s);t=yield this.fileUtility.listFiles(_);for(const s of t)yield this.uploadStravaRecord(s);const i=yield this.fileUtility.listFiles(H),e=yield this.fileUtility.listFiles(_);(i.length||e.length)&&null==this.uploadRecordsTimer&&(this.uploadRecordsTimer=setTimeout(()=>{this.uploadRecordsTimer=null,this.uploadRecords()},U))}catch(t){console.log(t)}finally{this.background.disable()}})),this.uploadAiRecord=t=>s.b(this,void 0,void 0,(function*(){try{yield this.fileUtility.checkFile(t);let i=yield this.fileUtility.readJSONFile(t);if(null!=i){const t=new Date(i.startTime),e=i.metrics;0!==Object.keys(e).length&&(yield this.backend.saveActivity(t,e.elapsedTime,e.distance,e.stepCount,e.avgPace,e.minPace,e.maxPace,e.movingTime,e.avgStride,e.minStride,e.maxStride,e.avgCadence,e.minCadence,e.maxCadence,e.avgLeftBalance,e.avgRightBalance,e.calories,e.avgHeartRate,e.minHeartRate,e.maxHeartRate,e.route))}yield this.fileUtility.deleteFile(t)}catch(i){console.log(i.message)}})),this.uploadStravaRecord=t=>s.b(this,void 0,void 0,(function*(){try{yield this.fileUtility.checkFile(t);let i=yield this.fileUtility.readJSONFile(t);if(null!=i){const t=new Date(i.startTime);if(i.gpxDataArray.length){const e=Number(i.avgPace);yield this.stravaService.uploadActivity(t,e,i.gpxDataArray)}}yield this.fileUtility.deleteFile(t)}catch(i){console.log(i.message)}})),this.saveLocalRecord=()=>s.b(this,void 0,void 0,(function*(){try{let t=this.startTime,i=yield this.getActivityMetrics(),e=i.avgPace;const s={startTime:t.toISOString(),metrics:i};yield this.fileUtility.saveTextFile(this.localRecordFilename+H,JSON.stringify(s));const a={startTime:t.toISOString(),gpxDataArray:this.gpxDataArray,avgPace:e};yield this.fileUtility.saveTextFile(this.localRecordFilename+_,JSON.stringify(a))}catch(t){console.log(t.message)}})),this.saveOriginalGPS=(t,i,e)=>{if(this.logGPSData){const s=this.walkingState?1:0,a=this.runningState?1:0,n=String(t)+","+String(i)+","+String(e)+","+this.stepCount+","+this.gyroDataX+","+this.gyroDataY+","+this.gyroDataZ+","+this.acceDataX+","+this.acceDataY+","+this.acceDataZ+","+this.magnDataX+","+this.magnDataY+","+this.magnDataZ+","+s+","+a+","+this.currHeartRate;this.originalGPSFileLog.append(n)}},this.saveStepCount=(t,i)=>{if(F){const e=String(t)+","+String(i);this.stepCountFileLog.append(e)}},this.saveGAM=(t,i,e,s,a,n,h,r,c,o,l)=>{if(W){const u=String(t)+","+String(a)+","+String(n)+","+String(h)+","+String(i)+","+String(e)+","+String(s)+","+String(r)+","+String(c)+","+String(o)+","+String(l);this.gamFileLog.append(u)}},this.saveLRReferece=(t,i,e,s)=>{if(E){const a=String(t)+","+String(i)+","+String(e)+","+String(s);this.LRreferenceFileLog.append(a)}},this.saveRunningState=(t,i,e)=>{if(N){const s=String(t)+","+(i?1:0)+","+(e?1:0);this.runningStateFileLog.append(s)}},this.saveHeartRate=(t,i)=>{if(Z){const e=String(t)+","+i;this.heartRateFileLog.append(e)}},this.runCommand=t=>s.b(this,void 0,void 0,(function*(){let i=!0;if(this.isBusy())i=!1;else if(t instanceof yt){const i=t;switch(i.type){case Tt.Start:this.startInternal(i.para);break;case Tt.Pause:this.pauseInternal();break;case Tt.PauseOnDisconnect:this.pauseInternal(!0);break;case Tt.Resume:this.resumeInternal();break;case Tt.ResumeOnConnect:this.resumeInternal(!0);break;case Tt.Stop:this.stopInternal()}}return i})),this.platform.ready().then(()=>{this.commandQueue=new P.a(this.runCommand),this.events.subscribe(n.k,this.evtSolosDisconnected),this.events.subscribe(n.j,this.evtSolosConnected),this.initVars(),this.uploadPendingRecords()})}findWalkingState(t){var i=Object(r.fft)(t),e=r.util.fftFreq(i,10),s=r.util.fftMag(i);return e.map((t,i)=>({freq:t,sp:s[i]})).filter((t,i)=>t.freq>mt&&t.sp>dt).reduce((t,i)=>t+Math.abs(i.sp),0)>10}findRunningState(t){var i=Object(r.fft)(t),e=r.util.fftFreq(i,10),s=r.util.fftMag(i);return e.map((t,i)=>({freq:t,sp:s[i]})).filter((t,i)=>t.freq>vt&&t.sp>pt).reduce((t,i)=>t+Math.abs(i.sp),0)>10}}return t.ngInjectableDef=M.ac({factory:function(){return new t(M.bc(n.l),M.bc(a.f),M.bc(h.a),M.bc(D.k),M.bc(a.Mb),M.bc(o.f),M.bc(l.c),M.bc(d.a),M.bc(m.a),M.bc(p.a),M.bc(v.a),M.bc(S.d),M.bc(f.a),M.bc(y.c),M.bc(C.e))},token:t,providedIn:"root"}),t})()},DaA9:function(t,i,e){"use strict";e.d(i,"c",(function(){return c})),e.d(i,"a",(function(){return o})),e.d(i,"b",(function(){return l})),e.d(i,"e",(function(){return u})),e.d(i,"d",(function(){return g}));var s=e("mrSG"),a=e("ZZ/e"),n=e("Zesz"),h=e("8Y7J"),r=e("xgBC");const c="evtPostureViewEnter",o="evtPostureAlertStateChange",l="evtPostureRemindIntervalChange";var u=function(t){return t[t.Normal=0]="Normal",t[t.Slight=1]="Slight",t[t.Serious=2]="Serious",t[t.Severe=3]="Severe",t}({});let g=(()=>{class t{constructor(t,i,e){this.storage=t,this.platform=i,this.us=e,this.alertLevelNum=u.Serious,this.rollReference=null,this.pitchReference=null,this.firstCalRoll=null,this.firstCalPitch=null,this.reminderMethod="voice",this.recordLimit=60,this.remindInterval=10,this.firstCalLRBalance=null,this.LRBalanceReference=null,this.firstCalExePitch=null,this.exePitchReference=null,this.setRollReference=t=>s.b(this,void 0,void 0,(function*(){if(t!=this.rollReference){this.rollReference=t;try{yield this.storage.set("Calibration-rollValue",t)}catch(i){console.log(i)}}})),this.eraseRollReference=()=>s.b(this,void 0,void 0,(function*(){try{this.rollReference=null,yield this.storage.remove("Calibration-rollValue")}catch(t){console.log(t)}})),this.setPitchReference=t=>s.b(this,void 0,void 0,(function*(){if(t!=this.pitchReference){this.pitchReference=t;try{yield this.storage.set("Calibration-pitchValue",t)}catch(i){console.log(i)}}})),this.erasePitchReference=()=>s.b(this,void 0,void 0,(function*(){try{this.pitchReference=null,yield this.storage.remove("Calibration-pitchValue")}catch(t){console.log(t)}})),this.setLRBalanceReference=t=>s.b(this,void 0,void 0,(function*(){if(t!=this.LRBalanceReference){this.LRBalanceReference=t;try{yield this.storage.set("Calibration-LRBalance",t)}catch(i){console.log(i)}}})),this.setExePitchReference=t=>s.b(this,void 0,void 0,(function*(){if(t!=this.exePitchReference){this.exePitchReference=t;try{yield this.storage.set("Calibration-exe-pitchValue",t)}catch(i){console.log(i)}}})),this.setAlertLevelNum=t=>s.b(this,void 0,void 0,(function*(){if(t!=this.alertLevelNum){this.alertLevelNum=t;try{yield this.storage.set("PostureReminder-alertLevelNum",t)}catch(i){console.log(i)}}})),this.setReminderMethod=t=>s.b(this,void 0,void 0,(function*(){if(t!=this.reminderMethod){this.reminderMethod=t;try{yield this.storage.set("PostureReminder-reminderMethod",t)}catch(i){console.log(i)}}})),this.setRemindInterval=t=>s.b(this,void 0,void 0,(function*(){if(t!=this.remindInterval){this.remindInterval=t;try{yield this.storage.set("PostureReminder-reminderInterval",t)}catch(i){console.log(i)}}})),this.setFirstCalRoll=t=>{this.firstCalRoll=t},this.setFirstCalPitch=t=>{this.firstCalPitch=t},this.setFirstCalExePitch=t=>{this.firstCalExePitch=t},this.setFirstCalLRBalance=t=>{this.firstCalLRBalance=t},this.setRecordLimit=t=>{this.recordLimit=t},this.getRollReference=()=>this.rollReference,this.getPitchReference=()=>this.pitchReference,this.isRollPitchReferencesCalibrated=()=>{const t=this.getRollReference(),i=this.getPitchReference();return null!=t&&null!=i},this.getExePitchReference=()=>this.exePitchReference,this.getLRBalanceReference=()=>this.LRBalanceReference,this.getAlertLevelNum=()=>this.alertLevelNum,this.getReminderMethod=()=>this.reminderMethod,this.getRemindInterval=()=>this.remindInterval,this.getFirstCalRoll=()=>this.firstCalRoll,this.getFirstCalPitch=()=>this.firstCalPitch,this.getFirstCalExePitch=()=>this.firstCalExePitch,this.getFirstCalLRBalance=()=>this.firstCalLRBalance,this.getRecordLimit=()=>this.recordLimit,this.platform.ready().then(()=>s.b(this,void 0,void 0,(function*(){try{this.platform.is("desktop")&&(this.rollReference=0,this.pitchReference=0,this.LRBalanceReference=0);let t=null;null!=(t=yield this.storage.get("Calibration-rollValue"))&&(this.rollReference=t),null!=(t=yield this.storage.get("Calibration-pitchValue"))&&(this.pitchReference=t),null!=(t=yield this.storage.get("Calibration-exe-pitchValue"))&&(this.exePitchReference=t),null!=(t=yield this.storage.get("Calibration-LRBalance"))&&(this.LRBalanceReference=t),null!=(t=yield this.storage.get("PostureReminder-alertLevelNum"))&&(this.alertLevelNum=t),null!=(t=yield this.storage.get("PostureReminder-reminderMethod"))&&(this.reminderMethod=t),null!=(t=yield this.storage.get("PostureReminder-reminderInterval"))&&(this.remindInterval=t)}catch(t){console.log(JSON.stringify(t))}})))}}return t.ngInjectableDef=h.ac({factory:function(){return new t(h.bc(r.b),h.bc(a.Mb),h.bc(n.a))},token:t,providedIn:"root"}),t})()},J5fJ:function(t,i,e){"use strict";e.d(i,"a",(function(){return a})),e.d(i,"b",(function(){return n}));var s=e("lGdP");class a extends s.k{constructor(t,i,e){super(t,!0,!1,!0),this.running=!1,this.accuStepCount=i,this.targetStepCount=e,this.useGPS=!1}}class n extends s.j{constructor(t,i,e,s,a,n,h,r,c){super(i,e,s,a,n,h,r,c),this.cfg=t,this.ttsTrainingStarted=this.translate.instant("ai-coach.activity-started"),this.ttsTrainingResumed=this.translate.instant("ai-coach.activity-resumed"),this.ttsTrainingPaused=this.translate.instant("ai-coach.activity-paused"),this.ttsTrainingEnded=this.translate.instant("ai-coach.activity-ended")}coachMetricDataChanged(){super.coachMetricDataChanged(),this.events.publish(s.a,this.getCoachMetricData())}getCoachMetricData(){return{targetStepCount:this.cfg.targetStepCount,accuStepCount:this.cfg.accuStepCount,movingTime:this.movingTime,stepCount:this.stepCount}}stopped(){let t=this.getSpokenTextWithMovingTime();this.audioPlayer.speech(!1,t),t=this.getSpokenTextStepCount(),this.audioPlayer.speech(!1,t);let i=this.stepCount;i<0&&(i=0),t=this.translate.instant("training.daily-goal-achieved",{value:(100*(this.cfg.accuStepCount+i)/this.cfg.targetStepCount).toFixed(0)}),this.audioPlayer.speech(!1,t,"",()=>{super.stopped()})}}},LRfq:function(t,i,e){"use strict";e.d(i,"b",(function(){return n})),e.d(i,"a",(function(){return r}));var s=e("lGdP"),a=e("8qa8");class n extends s.k{constructor(t,i,e,s,a,n,h){super(t,!0,!0,!1),this.running=!1,this.warmUpTime=i,this.warmUpCadence=e,this.fastWalkTime=s,this.fastWalkCadence=a,this.coolDownTime=n,this.coolDownCadence=h}}var h=function(t){return t.Idle="FAST_WALKING.Idle",t.WarmUp="FAST_WALKING.WarmUp",t.FastWalk="FAST_WALKING.FastWalk",t.CoolDown="FAST_WALKING.CoolDown",t.Stop="FAST_WALKING.Stop",t}({});class r extends s.j{constructor(t,i,e,s,a,n,r,c,o){super(i,e,s,a,n,r,c,o),this.getCurrentCadence=()=>this.movingTime<1e3*this.cfg.warmUpTime?this.cfg.warmUpCadence:this.movingTime<1e3*(this.cfg.warmUpTime+this.cfg.fastWalkTime)?this.cfg.fastWalkCadence:this.cfg.coolDownCadence,this.cfg=t,this.fastWalkState=h.Idle,this.fastWalkInitStepCount=0,this.fastWalkInitMovingTime=0,this.fastWalkAvgCadence=0,this.fastWalkCadenceArray=[]}started(){if(this.fastWalkState==h.Idle){this.fastWalkState=h.WarmUp;const t=this.translate.instant("fat-burn.say-warm-up");this.audioPlayer.speech(!1,t,"",()=>{const t=this.trainingSettings.getBeepVolume();this.audioPlayer.setVolume(a.e,t),this.audioPlayer.playMusic(!1,a.e,"",this.getCurrentCadence()),super.started()})}else this.audioPlayer.playMusic(!1,a.e,"",this.getCurrentCadence()),super.started()}coachPaused(){this.audioPlayer.stopMusic(a.e),super.coachPaused()}coachStopped(){this.audioPlayer.stopMusic(a.e),super.coachStopped()}stopped(){let t=this.getSpokenTextWithMovingTime();this.audioPlayer.speech(!1,t),t=this.getSpokenTextTotalDistance(),this.audioPlayer.speech(!1,t),t=this.getSpokenTextStepCount(),this.audioPlayer.speech(!1,t),this.calories>0&&(t=this.translate.instant("ai-coach.calories-is",{value:this.calories}),this.audioPlayer.speech(!1,t)),t=this.translate.instant("fat-burn.say-avg-spm-fast-walk",{value:this.fastWalkAvgCadence}),this.audioPlayer.speech(!1,t,"",()=>{super.stopped()})}beforeRunCoachReminder(){this.platform.is("ios")&&this.audioPlayer.stopMusic(a.e)}afterRunCoachReminder(){this.platform.is("ios")&&this.audioPlayer.playMusic(!1,a.e,"",this.getCurrentCadence())}coachMetricDataChanged(){if(super.coachMetricDataChanged(),this.movingTime>=1e3*(this.cfg.warmUpTime+this.cfg.fastWalkTime)){if(this.fastWalkState!=h.CoolDown){this.fastWalkState=h.CoolDown,this.audioPlayer.stopMusic(a.e);const t=this.translate.instant("fat-burn.say-cool-down");this.audioPlayer.speech(!0,t,"",()=>{this.audioPlayer.playMusic(!1,a.e,"",this.getCurrentCadence())})}}else if(this.movingTime>=1e3*this.cfg.warmUpTime){if(this.fastWalkState!=h.FastWalk){this.fastWalkState=h.FastWalk,this.audioPlayer.stopMusic(a.e);const t=this.translate.instant("fat-burn.say-fast-walk");this.audioPlayer.speech(!0,t,"",()=>{this.audioPlayer.playMusic(!1,a.e,"",this.getCurrentCadence()),this.fastWalkInitStepCount=this.stepCount,this.fastWalkInitMovingTime=this.movingTime})}if(0!=this.fastWalkInitMovingTime){const t=this.movingTime-this.fastWalkInitMovingTime,i=this.stepCount-this.fastWalkInitStepCount;this.fastWalkAvgCadence=0!=t&&i>=0?Math.round(i/(t/1e3/60)):0,this.coachActivity.getCadence()>0&&this.fastWalkCadenceArray.push(this.coachActivity.getCadence())}}this.events.publish(s.a,this.getCoachMetricData())}getCoachMetricData(){return{fastWalkCadence:this.cfg.fastWalkCadence,movingTime:this.movingTime,distance:this.distance,stepCount:this.stepCount,calories:this.calories,currentCadence:this.currentCadence,fastWalkAvgCadence:this.fastWalkAvgCadence,fastWalkCadenceArray:this.fastWalkCadenceArray}}}},N3Z2:function(t,i,e){"use strict";e.d(i,"b",(function(){return n})),e.d(i,"a",(function(){return h}));var s=e("lGdP"),a=e("8qa8");class n extends s.k{constructor(t,i){super(t,!0,!0,!1),this.targetCadence=i}}class h extends s.j{constructor(t,i,e,s,n,h,r,c,o){super(i,e,s,n,h,r,c,o),this.cadenceCnt=[],this.coachPaused=()=>{this.audioPlayer.stopMusic(a.e),super.coachPaused()},this.cfg=t,this.avgCadence=0}started(){const t=this.trainingSettings.getBeepVolume();this.audioPlayer.setVolume(a.e,t),this.audioPlayer.playMusic(!1,a.e,"",this.cfg.targetCadence),super.started()}coachStopped(){this.audioPlayer.stopMusic(a.e),super.coachStopped()}stopped(){let t=this.getSpokenTextWithMovingTime();this.audioPlayer.speech(!1,t),t=this.getSpokenTextTotalDistance(),this.audioPlayer.speech(!1,t),t=this.translate.instant("training.average-cadence",{x:this.avgCadence.toFixed(0)}),this.audioPlayer.speech(!1,t),t=this.translate.instant("training.achievement-is",{y:(100*this.avgCadence/this.cfg.targetCadence).toFixed(0)}),this.audioPlayer.speech(!1,t,"",()=>{super.stopped()})}beforeRunCoachReminder(){this.platform.is("ios")&&this.audioPlayer.stopMusic(a.e)}afterRunCoachReminder(){this.platform.is("ios")&&this.audioPlayer.playMusic(!1,a.e,"",this.cfg.targetCadence)}coachMetricDataChanged(){super.coachMetricDataChanged(),this.avgCadence=0!=this.movingTime&&this.stepCount>=0?Math.round(this.stepCount/(this.movingTime/1e3/60)):0,this.currentCadence>0&&this.cadenceCnt.push(this.coachActivity.getCadence()),this.events.publish(s.a,this.getCoachMetricData())}getCoachMetricData(){return{targetCadence:this.cfg.targetCadence,movingTime:this.movingTime,distance:this.distance,currentCadence:this.currentCadence,avgCadence:this.avgCadence,cadenceCnt:this.cadenceCnt}}}},VjBM:function(t,i,e){"use strict";e.d(i,"b",(function(){return f})),e.d(i,"a",(function(){return T}));var s=e("ZZ/e"),a=e("BHc3"),n=e("R3bG"),h=e("lGdP"),r=e("6mIw"),c=e("N3Z2"),o=e("xVX2"),l=e("8qa8"),u=e("AGLQ"),g=e("J5fJ"),d=e("lIDq"),m=e("LRfq"),p=e("3Cwc"),v=e("8Y7J"),S=e("TSSN"),f=function(t){return t[t.Posture=0]="Posture",t[t.Cadence=1]="Cadence",t[t.Interval=2]="Interval",t[t.StepCount=3]="StepCount",t[t.FastWalk=4]="FastWalk",t}({});let T=(()=>{class t{constructor(t,i,e,s,n,l,u,d,p){this.solosConnector=t,this.coachActivity=i,this.coachSettings=e,this.translate=s,this.events=n,this.audioPlayer=l,this.background=u,this.platform=d,this.trainingSettings=p,this.start=(t,i)=>{if(void 0===this.activeTraining){switch(t){case f.Posture:i instanceof r.b&&(this.activeTraining=new r.a(i,this.solosConnector,this.coachActivity,this.audioPlayer,this.translate,this.events,this.background,this.platform,this.trainingSettings));break;case f.Cadence:i instanceof c.b&&(this.activeTraining=new c.a(i,this.solosConnector,this.coachActivity,this.audioPlayer,this.translate,this.events,this.background,this.platform,this.trainingSettings));break;case f.Interval:i instanceof o.b&&(this.activeTraining=new o.a(i,this.solosConnector,this.coachActivity,this.audioPlayer,this.translate,this.events,this.background,this.platform,this.trainingSettings,this.coachSettings));break;case f.StepCount:i instanceof g.a&&(this.activeTraining=new g.b(i,this.solosConnector,this.coachActivity,this.audioPlayer,this.translate,this.events,this.background,this.platform,this.trainingSettings));break;case f.FastWalk:i instanceof m.b&&(this.activeTraining=new m.a(i,this.solosConnector,this.coachActivity,this.audioPlayer,this.translate,this.events,this.background,this.platform,this.trainingSettings));break;default:return!1}return this.events.subscribe(a.d,this.coachReminder),this.events.subscribe(a.i,this.coachStateChanged),this.events.subscribe(a.g,this.coachMetricDataChanged),this.events.subscribe(a.f,this.coachMetricDataChanged),this.activeTraining.start(i),!0}return!1},this.stop=()=>{void 0!==this.activeTraining&&this.activeTraining.stop()},this.pause=()=>{void 0!==this.activeTraining&&this.activeTraining.pause()},this.resume=()=>{void 0!==this.activeTraining&&this.activeTraining.resume()},this.isRunning=()=>!(void 0===this.activeTraining||!this.activeTraining.getBusy()&&this.activeTraining.getState()==h.i.Stopped),this.getTrainingType=()=>{if(void 0!==this.activeTraining){if(this.activeTraining instanceof r.a)return f.Posture;if(this.activeTraining instanceof c.a)return f.Cadence;if(this.activeTraining instanceof o.a)return f.Interval;if(this.activeTraining instanceof g.b)return f.StepCount;if(this.activeTraining instanceof m.a)return f.FastWalk}return null},this.getState=()=>void 0!==this.activeTraining?this.activeTraining.getState():null,this.getBusy=()=>void 0!==this.activeTraining?this.activeTraining.getBusy():null,this.getCoachMetricData=()=>void 0!==this.activeTraining?this.activeTraining.getCoachMetricData():null,this.getCoachIsTrainingTimesup=()=>void 0!==this.activeTraining?this.activeTraining.isTrainingTimesup():null,this.trainingDidStop=()=>{void 0!==this.activeTraining&&(this.events.unsubscribe(a.d,this.coachReminder),this.events.unsubscribe(a.i,this.coachStateChanged),this.events.unsubscribe(a.g,this.coachMetricDataChanged),this.events.unsubscribe(a.f,this.coachMetricDataChanged),this.activeTraining=void 0)},this.coachReminder=t=>{void 0!==this.activeTraining&&this.activeTraining.coachReminder()},this.coachStateChanged=t=>{void 0!==this.activeTraining&&(t.state==a.j.Running?this.activeTraining.coachStarted():t.state==a.j.Paused?this.activeTraining.coachPaused():t.state==a.j.Idle?this.activeTraining.coachStopped():t.state==a.j.Busy&&this.activeTraining.setBusy())},this.coachMetricDataChanged=t=>{void 0!==this.activeTraining&&(this.activeTraining.coachMetricDataChanged(),this.activeTraining.isTrainingTimesup()&&this.stop())},this.events.subscribe(h.e,this.trainingDidStop)}}return t.ngInjectableDef=v.ac({factory:function(){return new t(v.bc(n.l),v.bc(a.b),v.bc(d.a),v.bc(S.k),v.bc(s.f),v.bc(l.f),v.bc(u.a),v.bc(s.Mb),v.bc(p.e))},token:t,providedIn:"root"}),t})()},lGdP:function(t,i,e){"use strict";e.d(i,"d",(function(){return a})),e.d(i,"e",(function(){return n})),e.d(i,"f",(function(){return h})),e.d(i,"c",(function(){return r})),e.d(i,"b",(function(){return c})),e.d(i,"a",(function(){return o})),e.d(i,"g",(function(){return l})),e.d(i,"h",(function(){return u})),e.d(i,"i",(function(){return g})),e.d(i,"k",(function(){return d})),e.d(i,"j",(function(){return m}));var s=e("BHc3");const a="evtTrainingStateStarted",n="evtTrainingStateStopped",h="evtTrainingStateStopping",r="evtTrainingStatePaused",c="evtTrainingStateBusy",o="evtTrainingMetricsChanged",l="tagSpeechIntervalReminder",u="tagSpeechPostureReminder";var g=function(t){return t[t.Started=0]="Started",t[t.Paused=1]="Paused",t[t.Stopping=2]="Stopping",t[t.Stopped=3]="Stopped",t}({});class d{constructor(t,i,e,s){this.running=!0,this.trainingTime=t,this.movingTimeOn=i,this.distanceOn=e,this.stepCountOn=s,this.useGPS=!0}}class m{constructor(t,i,e,s,a,n,h,r){this.getState=()=>this.state,this.updateMetricData=()=>{this.movingTime=this.coachActivity.getMovingTime(),this.distance=this.coachActivity.getDistance(),this.stepCount=this.coachActivity.getStepCount(),this.calories=this.coachActivity.getCalories(),this.currentCadence=this.coachActivity.getCadence()},this.getBusy=()=>this.busy,this.setBusy=()=>{this.busy=!0,this.events.publish(c)},this.getTrainingTimeMS=()=>void 0!==this.basecfg?1e3*this.basecfg.trainingTime:0,this.isTrainingTimesup=()=>{const t=this.getTrainingTimeMS();return t>0&&this.movingTime>=t},this.solosConnector=t,this.coachActivity=i,this.audioPlayer=e,this.translate=s,this.events=a,this.background=n,this.platform=h,this.trainingSettings=r,this.state=g.Stopped,this.busy=!1,this.ttsTrainingStarted=this.translate.instant("training.training-started"),this.ttsTrainingResumed=this.translate.instant("training.training-resumed"),this.ttsTrainingPaused=this.translate.instant("training.training-paused"),this.ttsTrainingEnded=this.translate.instant("training.training-ended")}start(t){if(this.state!=g.Stopped)return!1;this.basecfg=t,this.movingTime=0,this.distance=0,this.stepCount=0,this.calories=0,this.currentCadence=-1;let i=s.a.Running;return t.running||(i=s.a.Walking),this.coachActivity.start(!0,i,t.useGPS),!0}pause(){return this.state==g.Started&&(this.coachActivity.pause(),!0)}resume(){return this.state==g.Paused&&(this.coachActivity.resume(),!0)}stop(){return(this.state==g.Started||this.state==g.Paused)&&(this.state=g.Stopping,this.events.publish(h),this.coachActivity.stop(),!0)}getCoachMetricData(){return null}beforeRunCoachReminder(){}getSpokenTextWithMovingTime(){return this.coachActivity.getSpokenTextMovingTime(!0)}getSpokenTextTotalDistance(){return this.coachActivity.getSpokenTextDistance()}getSpokenTextStepCount(){return this.coachActivity.getSpokenTextStepCount(!0)}coachReminder(){if(this.updateMetricData(),(this.basecfg.movingTimeOn||this.basecfg.distanceOn||this.basecfg.stepCountOn)&&(0==this.getTrainingTimeMS()||this.movingTime<this.getTrainingTimeMS())){this.beforeRunCoachReminder(),this.audioPlayer.flushPendingSpeech4tag(l);let t=!0;if(this.basecfg.movingTimeOn&&this.trainingSettings.getReminderTypeMovingTimeOn()){let i=this.getSpokenTextWithMovingTime();this.audioPlayer.speech(t,i,l),t=!1}if(this.basecfg.distanceOn&&this.trainingSettings.getReminderTypeDistanceOn()){let i=this.getSpokenTextTotalDistance();this.audioPlayer.speech(t,i,l),t=!1}if(this.basecfg.stepCountOn&&this.trainingSettings.getReminderStepCount()){let i=this.getSpokenTextStepCount();this.audioPlayer.speech(t,i,l),t=!1}this.afterRunCoachReminder()}}afterRunCoachReminder(){}coachMetricDataChanged(){this.state!=g.Stopping&&this.updateMetricData()}started(){this.busy=!1,this.state=g.Started,this.events.publish(a)}coachStarted(){this.state==g.Stopped&&this.background.enable();let t=this.ttsTrainingStarted;this.state==g.Paused&&(t=this.ttsTrainingResumed),this.audioPlayer.flushPendingSpeech4tag(l),this.audioPlayer.flushPendingSpeech4tag(u),this.audioPlayer.speech(!0,t,"",()=>{this.started()})}paused(){this.busy=!1,this.state=g.Paused,this.events.publish(r)}coachPaused(){this.audioPlayer.flushPendingSpeech4tag(l),this.audioPlayer.flushPendingSpeech4tag(u),this.audioPlayer.speech(!0,this.ttsTrainingPaused,"",()=>{this.paused()})}stopped(){this.background.disable(),this.busy=!1,this.state=g.Stopped,this.events.publish(n)}coachStopped(){this.state==g.Stopped?this.stopped():(this.audioPlayer.flushPendingSpeech4tag(l),this.audioPlayer.flushPendingSpeech4tag(u),this.audioPlayer.speech(!0,this.ttsTrainingEnded),this.stopped())}}},lIDq:function(t,i,e){"use strict";e.d(i,"e",(function(){return b})),e.d(i,"d",(function(){return M})),e.d(i,"c",(function(){return D})),e.d(i,"b",(function(){return k})),e.d(i,"a",(function(){return A}));var s=e("mrSG"),a=e("ZZ/e"),n=e("8Y7J"),h=e("xgBC");const r="CoachSettings",c="Unit",o="ReminderInterval",l="ReminderTypeHeartRate",u="ReminderTypePacing",g="ReminderTypeAveragePacing",d="ReminderTypeElapsedTime",m="ReminderTypeDistance",p="ReminderTypeMovingTime",v="ReminderTypeStepCount",S="ReminderTypeStride",f="ReminderTypeAverageStride",T="ReminderTypeCadence",y="ReminderTypeAverageCadence",R="ReminderTypeLeftBalance",C="ReminderTypeRightBalance",P="CoachAutoPause",b="Metric",M="Imperial",D="evtCoachUnitChanged",k="evtCoachIntervalChanged";let A=(()=>{class t{constructor(t,i,e){this.platform=t,this.storage=i,this.events=e,this.unit=b,this.reminderInterval=0,this.heartRate=!1,this.pacing=!1,this.avgPacing=!1,this.elapsedTime=!1,this.distance=!1,this.movingTime=!1,this.stepCount=!1,this.stride=!1,this.avgStride=!1,this.cadence=!1,this.avgCadence=!1,this.leftBalance=!1,this.rightBalance=!1,this.autoPause=!0,this.getKey=t=>r+"-"+t,this.setUnit=t=>s.b(this,void 0,void 0,(function*(){if((t==M||t==b)&&t!=this.unit){this.unit=t;try{yield this.storage.set(this.getKey(c),t),this.events.publish(D)}catch(i){console.log(i)}}})),this.getUnit=()=>this.unit,this.setReminderInterval=t=>s.b(this,void 0,void 0,(function*(){if(t>=0&&t!=this.reminderInterval){this.reminderInterval=t;try{yield this.storage.set(this.getKey(o),t),this.events.publish(k)}catch(i){console.log(i)}}})),this.getReminderInterval=()=>this.reminderInterval,this.setReminderHeartRateTypeOn=t=>s.b(this,void 0,void 0,(function*(){if(t!=this.heartRate){this.heartRate=t;try{yield this.storage.set(this.getKey(l),t)}catch(i){console.log(i)}}})),this.getReminderHeartRateTypeOn=()=>this.heartRate,this.setReminderTypePacingOn=t=>s.b(this,void 0,void 0,(function*(){if(t!=this.pacing){this.pacing=t;try{yield this.storage.set(this.getKey(u),t)}catch(i){console.log(i)}}})),this.getReminderTypePacingOn=()=>this.pacing,this.setReminderTypeAveragePacingOn=t=>s.b(this,void 0,void 0,(function*(){if(t!=this.avgPacing){this.avgPacing=t;try{yield this.storage.set(this.getKey(g),t)}catch(i){console.log(i)}}})),this.getReminderTypeAveragePacingOn=()=>this.avgPacing,this.setReminderTypeElapsedTimeOn=t=>s.b(this,void 0,void 0,(function*(){if(t!=this.elapsedTime){this.elapsedTime=t;try{yield this.storage.set(this.getKey(d),t)}catch(i){console.log(i)}}})),this.getReminderTypeElapsedTimeOn=()=>this.elapsedTime,this.setReminderTypeDistanceOn=t=>s.b(this,void 0,void 0,(function*(){if(t!=this.distance){this.distance=t;try{yield this.storage.set(this.getKey(m),t)}catch(i){console.log(i)}}})),this.getReminderTypeDistanceOn=()=>this.distance,this.setReminderTypeMovingTimeOn=t=>s.b(this,void 0,void 0,(function*(){if(t!=this.movingTime){this.movingTime=t;try{yield this.storage.set(this.getKey(p),t)}catch(i){console.log(i)}}})),this.getReminderTypeMovingTimeOn=()=>this.movingTime,this.setReminderTypeStepCountOn=t=>s.b(this,void 0,void 0,(function*(){if(t!=this.stepCount){this.stepCount=t;try{yield this.storage.set(this.getKey(v),t)}catch(i){console.log(i)}}})),this.getReminderTypeStepCountOn=()=>this.stepCount,this.setReminderTypeStrideOn=t=>s.b(this,void 0,void 0,(function*(){if(t!=this.stride){this.stride=t;try{yield this.storage.set(this.getKey(S),t)}catch(i){console.log(i)}}})),this.getReminderTypeStrideOn=()=>this.stride,this.setReminderTypeAverageStrideOn=t=>s.b(this,void 0,void 0,(function*(){if(t!=this.avgStride){this.avgStride=t;try{yield this.storage.set(this.getKey(f),t)}catch(i){console.log(i)}}})),this.getReminderTypeAverageStrideOn=()=>this.avgStride,this.setReminderTypeCadenceOn=t=>s.b(this,void 0,void 0,(function*(){if(t!=this.cadence){this.cadence=t;try{yield this.storage.set(this.getKey(T),t)}catch(i){console.log(i)}}})),this.getReminderTypeCadenceOn=()=>this.cadence,this.setReminderTypeAverageCadenceOn=t=>s.b(this,void 0,void 0,(function*(){if(t!=this.avgCadence){this.avgCadence=t;try{yield this.storage.set(this.getKey(y),t)}catch(i){console.log(i)}}})),this.getReminderTypeAverageCadenceOn=()=>this.avgCadence,this.setReminderTypeLeftBalanceOn=t=>s.b(this,void 0,void 0,(function*(){if(t!=this.leftBalance){this.leftBalance=t;try{yield this.storage.set(this.getKey(R),t)}catch(i){console.log(i)}}})),this.getReminderTypeLeftBalanceOn=()=>this.leftBalance,this.setReminderTypeRightBalanceOn=t=>s.b(this,void 0,void 0,(function*(){if(t!=this.rightBalance){this.rightBalance=t;try{yield this.storage.set(this.getKey(C),t)}catch(i){console.log(i)}}})),this.getReminderTypeRightBalanceOn=()=>this.rightBalance,this.setCoachAutoPauseOn=t=>s.b(this,void 0,void 0,(function*(){if(t!=this.autoPause){this.autoPause=t;try{yield this.storage.set(this.getKey(P),t)}catch(i){console.log(i)}}})),this.getCoachAutoPauseOn=()=>this.autoPause,this.platform.ready().then(()=>{this.storage.get(this.getKey(c)).then(t=>{null!=t&&(this.unit=t)}).catch(t=>{console.log(t)}),this.storage.get(this.getKey(o)).then(t=>{null!=t&&(this.reminderInterval=Number(t))}).catch(t=>{console.log(t)}),this.storage.get(this.getKey(l)).then(t=>{null!=t&&(this.heartRate=Boolean(t))}).catch(t=>{console.log(t)}),this.storage.get(this.getKey(u)).then(t=>{null!=t&&(this.pacing=Boolean(t))}).catch(t=>{console.log(t)}),this.storage.get(this.getKey(g)).then(t=>{null!=t&&(this.avgPacing=Boolean(t))}).catch(t=>{console.log(t)}),this.storage.get(this.getKey(d)).then(t=>{null!=t&&(this.elapsedTime=Boolean(t))}).catch(t=>{console.log(t)}),this.storage.get(this.getKey(m)).then(t=>{null!=t&&(this.distance=Boolean(t))}).catch(t=>{console.log(t)}),this.storage.get(this.getKey(p)).then(t=>{null!=t&&(this.movingTime=Boolean(t))}).catch(t=>{console.log(t)}),this.storage.get(this.getKey(v)).then(t=>{null!=t&&(this.stepCount=Boolean(t))}).catch(t=>{console.log(t)}),this.storage.get(this.getKey(S)).then(t=>{null!=t&&(this.stride=Boolean(t))}).catch(t=>{console.log(t)}),this.storage.get(this.getKey(f)).then(t=>{null!=t&&(this.avgStride=Boolean(t))}).catch(t=>{console.log(t)}),this.storage.get(this.getKey(T)).then(t=>{null!=t&&(this.cadence=Boolean(t))}).catch(t=>{console.log(t)}),this.storage.get(this.getKey(y)).then(t=>{null!=t&&(this.avgCadence=Boolean(t))}).catch(t=>{console.log(t)}),this.storage.get(this.getKey(R)).then(t=>{null!=t&&(this.leftBalance=Boolean(t))}).catch(t=>{console.log(t)}),this.storage.get(this.getKey(C)).then(t=>{null!=t&&(this.rightBalance=Boolean(t))}).catch(t=>{console.log(t)}),this.storage.get(this.getKey(P)).then(t=>{null!=t&&(this.autoPause=Boolean(t))}).catch(t=>{console.log(t)})})}}return t.ngInjectableDef=n.ac({factory:function(){return new t(n.bc(a.Mb),n.bc(h.b),n.bc(a.f))},token:t,providedIn:"root"}),t})()},xVX2:function(t,i,e){"use strict";e.d(i,"b",(function(){return r})),e.d(i,"a",(function(){return c}));var s=e("lGdP"),a=e("8qa8"),n=e("lIDq");const h=.015;class r extends s.k{constructor(t,i,e,s,a,n){super(t,!0,!0,!1),this.type=i,this.runDistance=e,this.runTime=s,this.restTime=a,this.interval=n}}class c extends s.j{constructor(t,i,e,r,c,o,l,u,g,d){super(i,e,r,c,o,l,u,g),this.beepSoundOn=!1,this.runRestStateTransitionStarted=()=>{this.getState()==s.i.Started&&1!=this.getBusy()&&(this.switchingRunRestState||(this.switchingRunRestState=!0,this.startBeepSound()))},this.runRestStateTransitionEnded=t=>{if(this.switchingRunRestState&&(this.switchingRunRestState=!1,this.stopBeepSound()),void 0!==t)switch(t){case 0:this.distanceRef=this.distance,this.timeRef=this.movingTime,this.lastDistance=this.distance,this.lastMovingTime=this.movingTime,this.speechStartRunning(),this.runPendingCoachReminder();break;case 1:this.distanceRef=this.distance,this.timeRef=this.movingTime,this.lastDistance=this.distance,this.lastMovingTime=this.movingTime,this.speechSlowDown(),this.runPendingCoachReminder();break;case 2:this.audioPlayer.speech(!0,this.translate.instant("training.all-sets-are-completed")),this.stop()}},this.runPendingCoachReminder=()=>{this.pendingCoachReminder&&(this.pendingCoachReminder=!1,this.coachReminder())},this.speechStartRunning=()=>{this.currentState=1,this.audioPlayer.speech(!1,this.translate.instant("training.num-of-sets",{x:this.currInterval+1})+this.translate.instant("training.start-run")),this.coachActivity.setMovingTimeAlwaysOn(!1)},this.speechSlowDown=()=>{this.currentState=2,this.audioPlayer.speech(!1,this.translate.instant("training.slow-down-n-rest")),this.coachActivity.setMovingTimeAlwaysOn(!0)},this.startBeepSound=()=>{if(!this.beepSoundOn){this.beepSoundOn=!0,this.audioPlayer.flushPendingSpeech4tag(s.g);const t=this.trainingSettings.getBeepVolume();this.audioPlayer.setVolume(a.a,t),this.audioPlayer.playMusic(!1,a.a,"",60)}},this.stopBeepSound=()=>{this.beepSoundOn&&(this.beepSoundOn=!1,this.audioPlayer.stopMusic(a.a))},this.getAlertDistance=()=>{const t=h;return this.coachSettings.getUnit()==n.d?this.cfgRunDistance-.62137*t:this.cfgRunDistance-t},this.publishTrainingMetricsChangedEvent=()=>{this.events.publish(s.a,this.getCoachMetricData())},this.getSpokenTextTotalDistance=()=>this.translate.instant("training.curr-run-distance-is")+" "+this.totalRunDistance.toFixed(2)+this.translate.instant(this.coachSettings.getUnit()==n.d?"ai-coach.miles":"ai-coach.k-m"),this.cfg=t,this.coachSettings=d}start(t){if(!super.start(t))return!1;this.currentState=0,this.distanceRef=0,this.totalRunDistance=0,this.lastDistance=0,this.currInterval=0,this.timeRef=0,this.totalRunTime=0,this.totalRestTime=0,this.lastMovingTime=0,this.switchingRunRestState=!1,this.pendingCoachReminder=!1,this.cfgRunDistance=this.coachSettings.getUnit()==n.d?.62137*this.cfg.runDistance:this.cfg.runDistance,this.restTimeLeft=-1}stop(){return!!super.stop()&&(this.coachActivity.setMovingTimeAlwaysOn(!1),!0)}coachMetricDataChanged(){if(super.coachMetricDataChanged(),this.getState()==s.i.Started){if(0==this.currentState)this.speechStartRunning();else if(1==this.currentState)if(this.totalRunDistance+=this.distance-this.lastDistance,this.lastDistance=this.distance,"distance"==this.cfg.type){const t=this.distance-this.distanceRef;t>=this.getAlertDistance()&&t<this.cfgRunDistance?this.runRestStateTransitionStarted():t>=this.cfgRunDistance&&this.runRestStateTransitionEnded(1)}else{this.totalRunTime+=(this.movingTime-this.lastMovingTime)/1e3,this.lastMovingTime=this.movingTime;const t=(this.movingTime-this.timeRef)/1e3;t>=60*this.cfg.runTime-6&&t<60*this.cfg.runTime?this.runRestStateTransitionStarted():t>=60*this.cfg.runTime&&this.runRestStateTransitionEnded(1)}else if(2==this.currentState){this.totalRestTime+=(this.movingTime-this.lastMovingTime)/1e3,this.lastMovingTime=this.movingTime;const t=(this.movingTime-this.timeRef)/1e3;this.restTimeLeft=this.cfg.restTime-t,t>=this.cfg.restTime-6&&t<this.cfg.restTime?this.runRestStateTransitionStarted():t>=this.cfg.restTime&&(this.currInterval++,this.currInterval>=this.cfg.interval?(this.restTimeLeft=-1,this.runRestStateTransitionEnded(2)):(this.restTimeLeft=-1,this.runRestStateTransitionEnded(0)))}this.publishTrainingMetricsChangedEvent()}else this.publishTrainingMetricsChangedEvent()}coachReminder(){this.switchingRunRestState?this.pendingCoachReminder=!0:super.coachReminder()}getCoachMetricData(){return{type:this.cfg.type,movingTime:this.movingTime,distance:this.distance,runDistance:this.totalRunDistance,runTime:this.totalRunTime,restTime:this.totalRestTime,interval:this.currInterval,restTimeLeft:this.restTimeLeft}}paused(){this.runRestStateTransitionEnded(),super.paused()}stopped(){this.runRestStateTransitionEnded();let t=this.getSpokenTextWithMovingTime();if(this.audioPlayer.speech(!1,t),t=super.getSpokenTextTotalDistance(),this.audioPlayer.speech(!1,t),"distance"==this.cfg.type){t=this.coachSettings.getUnit()==n.d?this.translate.instant("training.run-distance-is")+" "+this.totalRunDistance.toFixed(2)+this.translate.instant("training.mi"):this.translate.instant("training.run-distance-is")+" "+this.totalRunDistance.toFixed(2)+this.translate.instant("training.km"),this.audioPlayer.speech(!1,t);let i=Math.floor(this.totalRestTime/60),e=Math.floor(this.totalRestTime%60);t=this.translate.instant("training.rest-time-is")+(0==i?"":i+this.translate.instant("training.minutes"))+(0==e&&0!=i?"":e+this.translate.instant("training.sec")),this.audioPlayer.speech(!1,t,"",()=>{super.stopped()})}else{let i=Math.floor(this.totalRunTime/60),e=Math.floor(this.totalRunTime%60),s=Math.floor(this.totalRestTime/60),a=Math.floor(this.totalRestTime%60);t=this.translate.instant("training.run-time-is")+(0==i?"":i+this.translate.instant("training.minutes"))+(0==e&&0!=i?"":e+this.translate.instant("training.sec")),this.audioPlayer.speech(!1,t),t=this.translate.instant("training.rest-time-is")+(0==s?"":s+this.translate.instant("training.minutes"))+(0==a&&0!=s?"":a+this.translate.instant("training.sec")),this.audioPlayer.speech(!1,t,"",()=>{super.stopped()})}}}},yDgC:function(t,i,e){"use strict";e.d(i,"a",(function(){return a}));let s=1;class a{constructor(){this.timers={},this.addTimer=(t,i,e=!1,a)=>{const h=s++,r=new n(t,i,e,a),c=String(h);return this.timers[c]=r,h},this.removeTimer=t=>{const i=String(t);null!=this.timers[i]&&delete this.timers[i]},this.changeInterval=(t,i)=>{const e=String(t);null!=this.timers[e]&&(0!=i&&(this.timers[e].tNow=this.timers[e].tTotal%i),this.timers[e].tInterval=i)},this.update=t=>{for(let i in this.timers)this.timers[i].isStop()||this.timers[i].update(t),this.timers[i].isStop()&&delete this.timers[i]}}}class n{constructor(t,i,e=!1,s){this.para=void 0,this.tTotal=0,this.tNow=0,this.tInterval=0,this.once=!1,this.stop=!1,this.update=t=>{this.stop||(this.tTotal+=t,0!=this.tInterval&&(this.tNow+=t,this.tNow>=this.tInterval&&(this.tNow%=this.tInterval,this.fn(this.para),this.once&&(this.stop=!0))))},this.isStop=()=>this.stop,this.fn=t,this.tInterval=i,this.once=e,this.para=s}}}}]);